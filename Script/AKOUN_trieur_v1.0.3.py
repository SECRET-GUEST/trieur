#          ████████     ██████
#         █░░░░░░░░██_██░░░░░░█
#        █░░░░░░░░░░░█░░░░░░░░░█
#       █░░░░░░░███░░░█░░░░░░░░░█
#       █░░░░███░░░███░█░░░████░█
#     █░░░██░░░░░░░░███░██░░░░██
#    █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#    █░░░░░░░░░░░░░██████░░░░░████░░█
#    █░░░░░░░░░█████░░░████░░██░░██░░█
#   ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
#  █░░░░░░░░░░░░░░█████████░░█████████
# █░░░░░░░░░░█████ ████   ████ █████ █
# █░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
# /            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#        \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#      |               |                                 |
                
#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  |                                     |
                
#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    |
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#           |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#   |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                               |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#                |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#        |                         Ce trieur permet de calculer le prix plus
                
#                              rapidement pour des artistes cotés AKOUN tels que                      |                                           |               |                                           |               |                                           |                    |                                           |
                
#                           /                      |    v    |                    \
                
#                   Nathacha , artiste peintre de l'abstraction https://www.artnathacha.com/                |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |
#                                                                                                    |                                                                 |                      |                     |                       |                      |                     |                       |                      |                     |                            |
#           Afin d'éviter d'avoir à passer par un tableur, il est possible qu'une IA s'y glisse a terme
#      |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                                |                                   |     |                  
#                   |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#              |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                 |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                         =)
                
#
#                                |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#              |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#      |                        |                                         |                                |
                
#
#                                                     !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#      |               |                                 !
                
#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  !                                     |
                
#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    !
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
                
#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#           |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|
                

import os,re,sys,csv,logging,configparser,time

from replacer import ImageRenamer
from filigrane import Filigrane
from btn_all_for_one import btn_for_one
from randonamer import randonaming

from PIL import Image
from unidecode import unidecode

from PyQt5.QtCore import Qt, QFile, QTextStream,QProcess, QTimer, QEventLoop
from PyQt5.QtGui import QIntValidator, QIcon ,QPixmap
from PyQt5.QtWidgets import (QApplication, QMainWindow, QPushButton, QFileDialog, QLabel, QLineEdit, QCheckBox,QVBoxLayout,
                             QWidget, QMessageBox, QTextBrowser, QStyleFactory, QDialog,QSplashScreen, qApp)
from PyQt5.QtWebEngineWidgets import QWebEngineView

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                

#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3
                

def ressource_path(relative_path):
    try:
        base_path=sys._MEIPASS
                
    except Exception:
        base_path = os.path.abspath('.')
                
    return os.path.join(base_path ,relative_path)
                
# Pour que la création d'un fichier executable s'effectue, il faut inclure tout les chemins relatif dans ressource_path()
# Exemple : 
# /icon/lol.png  DEVIENT  ressource_path(/icon/lol.png)
# idem dés que l'on ouvre un fichier relatif en lecture, ou en écriture.
                

#Tout d'abord on vient créer une classe permettant l'ouverture de notre logo
#Le logo s'affichant dans une fenetre transparente, il faudra donc accepter les clics de
#souris sinon cette derniere verra ca comme une demande de fermeture.
class showlogo(QSplashScreen):
    def mousePressEvent(self, event):
        event.accept()



#Création d'une classe contenant nos fonctions et boutons principaux
class trieur(QMainWindow):
    def __init__(self):
        super().__init__()
                
        self.folder = None
                
        #Charger le fichier CSS
        script_dir = os.path.dirname(os.path.abspath(__file__))
        self.css_path = os.path.join(script_dir, ressource_path('css/dark.css'))
        
        #Lire le fichier de configuration pour récupérer le mode précédent
        self.config = configparser.ConfigParser()
        self.config.read('config.ini')
        self.mode = self.config.get('settings', 'mode', fallback='light')

        #Appliquer la feuille de style globale
        qApp.setStyle(QStyleFactory.create('Fusion'))
        qApp.setStyleSheet(self.load_stylesheet(self.css_path))

        self.copy_first() # Voila un tuto pour la compréhension de la notion "self" : https://www.edureka.co/blog/self-in-python/#what )
        self.GUI() #On initialise l'interface utilisateur
                
        #On applique un facteur de zoom pour la fenetre tuto
        self.zoom_factor = 1.0

        #MIci on check si le dark mode est activé ou non pour pouvoir l'enregistrer dans la configuration
        if self.mode == 'dark':
            self.setStyleSheet(self.load_stylesheet(ressource_path("css/dark.css")))
            self.btn_d4rk.setText("L1ght Mode") #Du coups non c'était pas un bug ^^
        else:
            self.setStyleSheet(self.load_stylesheet(ressource_path("css/light.css")))            
            self.btn_d4rk.setText("D4rk Mode")

#On rajoute immédiatement une fonction pour lire notre fichier css        
    def load_stylesheet(self, path):
        file = QFile(path)
        file.open(QFile.ReadOnly | QFile.Text)
        stream = QTextStream(file)
        return stream.readAll()


    #Une fonction pour changer le mode de la fenêtre
    def dark_mode(self):
        #Activation/désactivation du mode sombre
        if self.btn_d4rk.isChecked():
            self.setStyleSheet(self.load_stylesheet(ressource_path("css/dark.css")))
            self.mode = 'dark'
            self.btn_d4rk.setText("Light Mode")
        else:
            self.setStyleSheet(self.load_stylesheet(ressource_path("css/light.css")))
            self.mode = 'light'
            self.btn_d4rk.setText("Dark Mode")

        #Enregistrement du mode dans le fichier de configuration
        if 'settings' not in self.config: #Si le fichier de configuration n'existe pas
            self.config['settings'] = {} #On le crée
        self.config['settings']['mode'] = self.mode #On enregistre le mode dans le fichier de configuration
        with open('config.ini', 'w') as configfile: 
            self.config.write(configfile)



    


#Maintenant on va s'occuper de l'ergonomie du tuto :
#Fonction pour gérer le scroll
    def wheelEvent(self, event) :  
        if event.modifiers() == Qt.ControlModifier:#Si la touche ctrl est appuyée
            if  event.angleDelta().y()> 0 :  #si on essaie de zoomer
                self.zoom_in() #on zoom
                event.accept()

            elif event.angleDelta().y()< 0 :#et inversement pour dezoomer
                self.zoom_out() 
                event.accept()

        else:#Sinon on reprends l'utilisation normale de la molette (important pour éviter les erreurs d'impossible de rezoomer / dezoomer)
            super().wheelEvent(event) 


#Fonction pour zoomer    
    def zoom_in(self):
        #Récupére le facteur de zoom actuel
        zoom_factor = self.webview.zoomFactor()

        #Augmenter le zoom
        zoom_factor += 0.1

        #on enregistre le nouveau facteur de zoom
        self.webview.setZoomFactor(zoom_factor)


#Fonction pour dézoomer     
    def zoom_out(self):  
        zoom_factor = self.webview.zoomFactor() 
        zoom_factor -= 0.1 
        self.webview.setZoomFactor(zoom_factor)


#.-=~=-.                                                                       .-=~=-.#
#(__  _)-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-(__  _)#
#( _ __)                                                                       ( _ __)#
#(__  _) Toujours dans notre fenetre, on va maintenant definir les algorithmes (__  _)#
#(__  _)                                                                       (__  _)#
#(_ ___)-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-(_ ___)#
#`-._.-'                                                                       `-._.-'#
                

                
#___  _  _ ____ ____ 
#|__] |  | | __ [__  
#|__] |__| |__] ___] 
                    
#La première concernera la gestion des erreurs dans l'application
                
#Fonction pour les erreurs au sein des autres fonctions
    def ERRORS(self, message, exception=None):
                
        alert = QMessageBox()
        alert.setWindowTitle("GAME OVER")
        alert.setText(message)
        alert.setIcon(QMessageBox.Warning)
                
        alert_button = alert.addButton("Ca coince ici !", QMessageBox.ActionRole)
                
        alert.exec_()
                
        if alert.clickedButton() == alert_button and alert_button.text() == "Ca coince ici !" and exception is not None:
            logger.error(str(exception), exc_info=True)
            os.startfile('error.log')
                

                

#Fonction pour rechercher si des fichiers ne sont pas au bon format
    def NOPE(self, folder):
                
    #On commence par définir les extensions supportées
        ext_SUPPORTED = {'.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg','.pcd', 
                         '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif','.tiff', '.xbm',
                         '.xpm', '.txt', '.text','.csv'}
                
    #Une liste vide qui contiendra nos chemins vers les images à dégager
        non_supported_files = []
    #On recherche dans tout les dossiers/ sous dossiers du dossier selectionné
        for subdir, _, files in os.walk(folder): #le "_" sert a dire que la variable n'est pas utilisé (en l'occurence on parle ici du répertoire des dossiers), c'est pour aléger la mémoire pour rien.
            for file in files:
                

                filename, extension = os.path.splitext(file)
                
                #Si des fichiers dont les extensions ne sont pas supportées,
                if extension.lower() not in ext_SUPPORTED:
                    #On ajoute ces fichiers dans notre liste
                    non_supported_files.append(os.path.join(subdir, file))
                
        if non_supported_files:
                
            A_NOPE = QMessageBox()
                
            A_NOPE.setWindowTitle("SHhhTOP!")
            A_NOPE.setText(f"Je ne supporte pas ce type de fichier: \n\n{chr(10).join(non_supported_files)}\n\n"
                           f"Je ne traite que les formats suivant : \n.bmp, .png, .jpg, .dib, .dcx, .gif, .im, .jpe, .jpeg, .pcd, .pcx, .png, .pbm, .pgm, .ppm, .psd, .tif, .tiff, .xbm, ou .xpm ")
            A_NOPE.setIcon(QMessageBox.Warning)
            
            btn_yes = A_NOPE.addButton("LANCER QUAND MEME !", QMessageBox.AcceptRole)
                
            A_NOPE.exec_()
                
            if A_NOPE.clickedButton() == btn_yes:
                return True
                
        return True #Permet de continuer puisque le message d'erreur n'est qu'a titre informatif
                


#Ceci est completement facultatif, mais ici on créer un pop up pour notifier l'utilisateur de ne pas oublier de faire une copie des dossiers avant de les manipuler :
    def copy_first(self):
        #Affichage du disclaimer dans un popup       
        if 'General' not in self.config.sections():
            self.config.add_section('General')

        disclaimer =self.config.getboolean('General', 'disclaimer', fallback=True)

        if disclaimer:

            msgBox=QMessageBox()
            msgBox.setText("PENSEZ A CREER UNE COPIE DE VOS FICHIERS AVANT DE LES MANIPULER")
            checkbox= QCheckBox("Ne plus afficher au démarrage")
            msgBox.setCheckBox(checkbox)

            reply = msgBox.exec_()

            # Enregistrement des préférences de l'utilisateur dans le fichier de configuration
            if 'General' not in self.config.sections():
                self.config.add_section('General')
            self.config.set('General','disclaimer', str(not checkbox.isChecked()))

            with open('config.ini', "w") as configfile:
                self.config.write(configfile)
                
#____ ____ _    ____ ____ ___ _ ____ _  _ 
#[__  |___ |    |___ |     |  | |  | |\ | 
#___] |___ |___ |___ |___  |  | |__| | \| 
                                         
                

#Maintenant notre fonction pour appeler les dossiers qu'on réutilisera un peu partout
    def select_folder(self):
                
        global folder
                
        try:
            options = QFileDialog.Options()
            options |= QFileDialog.ReadOnly 
            folder = QFileDialog.getExistingDirectory(self, "Selectionnez un dossier", "",options=options) 
                
            #Cette partie sert à éviter les erreurs de selection de dossier 
            if folder:      
                if not self.NOPE(folder):
                    return        
            self.folder = folder
                
            if not folder: 
                return None
                
            # Vérifier que le dossier est valide et enregistrer le chemin du dossier
            if not self.check_folder(folder):
                return None            
                
            return self.folder
                
        except Exception as e:
            self.ERRORS("Je n'arrive pas à ouvrir le dossier \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return
                

    def check_folder(self, folder):
        # Vérifier que le dossier existe et qu'il contient des fichiers
        if not os.path.isdir(folder):
            self.ERRORS("Ce n'est pas un dossier.")
            return False
        
        if not os.listdir(folder):
            self.ERRORS("Le dossier est vide.")
            return False
        return True
                

                

                
#___  ____ _ ____ ____    _  _ ____ _  _ ____ ____ 
#|__] |__/ | |    |___    |\/| |__| |_/  |___ |__/ 
#|    |  \ | |___ |___    |  | |  | | \_ |___ |  \ 
                

                
#Ici, nous allons définir comment créer une liste à partir des fichiers d'un dossier et de ses sous-dossiers. 
#Cela permettra de créer différentes listes, y compris une les regroupant.
                

#Fonction pour renommer correctement nos images pour la suite :
    def img_rename(self):
                
        if self.folder is None:
            return None
        
        #Ici on demande au systeme de stocker dans une variables "files" le chemin de tout les fichiers dans le dossier choisi (sous dossiers inclus)
        files = [f for f in os.listdir(self.folder) if os.path.isfile(os.path.join(self.folder, f)) ] 
                
        #Création de la boucle de recherche dans tout les (sous)dossiers
        for subdir, _, files in os.walk( self.folder):
            for file in  files:
                
                old = os.path.join(subdir, file) #Notre variable contenant les noms des anciens fichiers 
                filename, extension = os.path.splitext(file) #Séparation du nom de l'extension
                
                #Remplacement des caractères spéciaux par des espaces, des lettres accentuées par leur correspondance ("è" devient "e") avec unidecode
                new_file = re.sub(r'[^a-zA-Z0-9]+', ' ', unidecode(filename)) 
                new_file = re.sub("^\d+\s", "", new_file) # Supprime le premier nombre (si les images sont numérotées dans le nom pour éviter les erreurs futures)

                #Ce qui suit n'est plus particulierement utile puisque j'ai modifier l'expression de recherche des tailles :
                new_file = re.sub(r'([0-9])X', r'\1x', new_file) # Transforme les X majuscules après un nombre (entre 0 et 9), en x minuscule
                new_file = re.sub(r'(\d)\s*x\s*(\d)', r'\1x\2', new_file, flags=re.IGNORECASE) #Supprime les espaces autour des x
                new_file = re.sub(r'(\d)\s*cm', r'\1cm', new_file, flags=re.IGNORECASE) #Supprime les espaces à gauche des cm
                new_file = re.sub(r'(\d)\s*x\s*(\d)', r'\1x\2', new_file, flags=re.IGNORECASE)
                
                #On va de nouveau renomme, mais cette fois on supprime les mots ressemblant au nom du dossier ouvert, mais au """singulier""".
                for subfolder in os.path.relpath(subdir, folder).split(os.sep):
                    if subfolder != '.':
                        singular = subfolder[:-1] if subfolder.endswith('s') else subfolder #On définit que singulier = sans s (flemme <3)
                        new_file = re.sub(subfolder, '', new_file, flags=re.IGNORECASE) # Supprime les mots ressemblants au nom du dossier
                        new_file = re.sub(singular, '', new_file, flags=re.IGNORECASE) #Supprime les mots ressemblants au nom du dossier au singulier
                #Renommage du fichier
                new = os.path.join(subdir, new_file + extension)
                
                # Vérifier si le fichier existe déjà dans le dossier
                while  os.path.exists(new):
                    # Générer un nouveau nom de fichier unique
                    new_file = new_file + "_1"
                    new= os.path.join(subdir, new_file + extension)
                
                os.rename(old, new)
                

                
#Pop up pour demander la cote akoun
    def demander_cote_akoun(self):
                
        #Créer la pop-up pour demander la cote AKOUN
        pop_akoun = QMessageBox()
        pop_akoun.setWindowTitle("Prix avec cotation AKOUN")
                
        #Label pour le texte
        lab_akoun = QLabel("Entrez votre cote AKOUN :")
        lab_akoun.setAlignment(Qt.AlignCenter)

        #Demande d'entrer la cote AKOUN
        txt_akoun = QLineEdit()
        txt_akoun.setMaxLength(7)
        txt_akoun.setPlaceholderText("Laissez vide pour renommer sans prix")
        txt_akoun.setValidator(QIntValidator())

        #Répartition des éléments à la pop-up
        lay_akoun =pop_akoun.layout()
        lay_akoun.addWidget(lab_akoun, 0, 0)
        lay_akoun.addWidget(txt_akoun, 1, 0)
        pop_akoun.setLayout(lay_akoun)
                
        btn_launch   = pop_akoun.exec_()
                
        #Si le bouton OK a été cliqué mais qu'il ne contient rien,ou qu'on a annulé l'opération, on revient en arriere
        if btn_launch ==  QMessageBox.RejectRole or txt_akoun.text() == "":
            return 
                
        #Sinon ciao
        else:
            return int(txt_akoun.text()) # Sinpn on revient en arriere avec la cote enregistrée.
                

                

#Fonction pour enregistrer le prix dans les images du dossier choisi (sous dossiers inclus)             
    def image_formatter(self):
        subdirs = []
        cote_akoun = self.demander_cote_akoun() 
        try:
            for subdir, _, _ in os.walk(self.folder):
                subdirs.append(subdir)  
                
                image_infos = []  # initialisation de la liste "image_infos"
                size = "" 
                
                for file in os.listdir(subdir): #On regarde les extensions pour éviter les erreurs de formatage
                    if not any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                        continue
                
                    #on récupère les informations de chaque image
                    image_info = {"num": len(image_infos) + 1}
                    image_infos.append(image_info)  # ajout de "image_info" à la liste "image_infos"
                    image_info["type"] = os.path.basename(subdir) 
                
                    with Image.open(os.path.join(subdir, file)) as picture:
                        sizes = re.findall(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', file.lower()) #On regarde si il y a des expressions de taille de chaque image



                        if sizes: #Si il y en a
                            try:
                                image_info["longueur"] = int(sizes[0][0]) #on les sauvegarde dans des tableaux, le premier 0 définissant la ligne, le 2eme la colone
                                image_info["hauteur"] = int(sizes[0][1]) 
                                image_info["profondeur"] = int(sizes[0][2]) if sizes[0][2] else 1 #Si il n'y a pas de profondeur, on le sauvegarde en 1
                
                                if image_info["profondeur"] == 1 : #Si la profondeur est 1 on la supprime de la taille
                                    size = f"{image_info['longueur']}x{image_info['hauteur']}"
                                else :
                                    size = f"{image_info['longueur']}x{image_info['hauteur']}x{image_info['profondeur']}"   
                
                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec {picture.filename}", e)

                        else: #Si il n'y en a pas on va convertir les pixels en cm
                            try:

                                width, height =  picture.size 
                                Image.MAX_IMAGE_PIXELS = None #on évite la limite de taille d'image imposée par python

                                dpi = picture.info.get("dpi", (300, 300)) #Applique 300 dpi par défaut si on a pas les info sur la résolution
                                width_cm = round(width / dpi[0] * 2.54) #2.54 est le ratio standard
                                height_cm = round(height / dpi[1] * 2.54)

                                image_info["longueur"] = width_cm
                                image_info["hauteur"] = height_cm
                                image_info["profondeur"] = 1 #On met la profondeur à 1 pour que la taille de l'image soit calculée

                                size = f"{image_info['longueur']}x{image_info['hauteur']}" 
                
                            except Exception as e:
                                self.ERRORS("Il y a un probleme concernant la résolution des images, ou leur taille \n\n je vais tenter d'appliquer un ratio standard (1cm = 37.79527559055 pixels) \n\n Ce ne sera pas super précis, il vaudrait mieux modifier les images et recommencer", e)
                                try : #Si le calcul via les DPI ne fonctionne pas, on essaie calcul a l'aide d'un ratio fixe.

                                    width, height =  picture.size 
                                    Image.MAX_IMAGE_PIXELS = None
                                    width, height = picture.size 

                                    ratio = 37.79527559055 

                                    width_cm = round(width / ratio)
                                    height_cm = round(height / ratio)

                                    image_info["longueur"] = width_cm
                                    image_info["hauteur"] = height_cm
                                    image_info["profondeur"] = 1

                                    size = f"{image_info['longueur']}x{image_info['hauteur']}" 

                                except Exception as e:
                                    self.ERRORS("Il y a un serieux probleme avec les metadonnées de {picture.filename}, \n\n Je n'arrive pas à récupérer les informations de longueur x largeur pour les transformer, elles semblent corrompues", e)
                                    return 
                        


                    if cote_akoun is not None and cote_akoun > 0: #On vérifie si la cote_akoun est valide au quel cas on applique le calcul suivant pour trouver son prix ((longueur x hauteur x profondeur)*cote akoun /3250)

                
                        prix =  round((image_info["longueur"]*image_info["hauteur"]*image_info["profondeur"]*cote_akoun)/3250) 
                
                    #on récupere l'ancien nom et on le modifie en le séparant d'abord de l'extension puis en supprimant les anciennes valeurs de tailles pour ne pas les avoir en double par la suite
                    old_path = os.path.join(subdir, file)
                    old_name, extension = os.path.splitext(file) 
                    old_name = re.sub(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', '', old_name, flags=re.IGNORECASE).strip()
                
                    #On renomme avec le nouveau prix si l'utilisateur a utilisé une cote, sinon on renomme sans le prix
                    if cote_akoun is not None and cote_akoun > 0: 
                        new_name = f"{image_info['type']},{str(image_info['num']).zfill(5)},{old_name},{size}cm,{str(prix)}€{extension}"

                    #Par ailleurs, on sépare le nom avec des "," pour mots-clés ou pour faire un tableau plus tard, et on rajoute des 0 devant le numéro pour le repérer facilement au besoin plus tard.
                    
                    else :
                        new_name = f"{image_info['type']},{str(image_info['num']).zfill(5)},{old_name},{size}cm,{extension}"    
                
                    new_path = os.path.join(subdir, new_name)
                
                    # on renomme le fichier
                    try:
                        os.rename(old_path, new_path)
                    except Exception as e:
                        self.ERRORS(f"Je n'arrive pas à renommer le fichier {old_path}", e)
                

        except Exception as e:
            self.ERRORS("Je n'arrive pas à formater les images", e)
    
                

                                
#Fonction permettant de cleaner le nom des images ainsi que les futures listes
    def cleaner(self):
        for subdir, _, files in os.walk(self.folder):
            for file in files:
                
                #Vérification si le nom de fichier esst bien dans une liste
                if file in ('0list.txt', 'ALL_IN.txt'):
                    file_path = os.path.join(subdir, file)
                
                    #Suppression des données de type "90x90cm..." ou les doubles espaces,... on encode le format en UTF-8 pour que ce soit lu par python et résoudre les problemes de compatibilité
                    with open(file_path, "r", encoding="utf8") as f:
                        lines = f.readlines()
                
                    with open(file_path, "w", encoding="utf8") as f:
                        for line in lines:

                            new_line = re.sub(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', '', line.lower())
                            new_line = re.sub(r'(\s{2,})', ' ', new_line).strip() + '\n' 
                            
                            if new_line.strip() or line.strip(): #vérifie si les lignes sont vides ou non
                                f.write(new_line)

                                

#Maintenant qu'on a établi toute nos fonctions, on les fait se jouer une par une à l'aide d'un index appelé par l'utilisateur
    def price_making (self):
                
        #Selection du dossier
        self.select_folder()
        if not folder: 
            return
                
        #Selection du dossier
        self.img_rename()
                
        #Appel la fonction d'enregistrement des listes
        self.image_formatter()
                
        #Appel de la fonction pour cleaner les listes        
        self.cleaner()
                

        QMessageBox.information(self,"Information", "Le tri s'est bien effectué. \n J'ai créé la liste dans le dossier concerné")
                

                
#___  ____ _    ____ ___ ____    ____ ____ ____ _  _ _    ____ ____    ____ _  _ ___  ____ ____ ____ ____ _ ____ _  _ ____ 
#|  \ |___ |    |___  |  |___    |__/ |___ | __ |  | |    |__| |__/    |___  \/  |__] |__/ |___ [__  [__  | |  | |\ | [__  
#|__/ |___ |___ |___  |  |___    |  \ |___ |__] |__| |___ |  | |  \    |___ _/\_ |    |  \ |___ ___] ___] | |__| | \| ___] 
                                                                                                                          
                
#Ici on va s'attaquer aux expressions régulières dans le nom des fichiers
#On commence par selectionner le dossier via une fonction de recherche
    def remove_regex(self):
                
        #Selection du dossier
        self.select_folder()
                
        if not folder:
            return
        
        regex_list = []
 
        self.rem_regex(folder, regex_list) 
                

                

#Une fonction évitant les erreurs dans les fichiers, on ajoute un numéro aux images renommées avec un meme nom qu'une autre
    def get_unique_filename(self,folder,filename):

        base, ext = os.path.splitext(filename)
        num = 1
        new_name = filename

        while os.path.exists(os.path.join(folder,new_name)):

            new_name = f"{base}__NOM EN DOUBLE{num}__{ext}" #On ajoute "nom en double +1 numero" avant l'extension
            num += 1

        return new_name
    
                
                

#Maintenant on va créer une interface graphique dans un pop up pour demander la suppression des expressions régulières inutiles      
    def rem_regex(self, folder,regex_list=None)  :
        #Afficher un popup pour demander l'expression régulière à supprimer
        dialog = QDialog(self)
    
        dialog.setWindowTitle("Supprimer une expression régulière")
        label = QLabel("Entrez les expressions régulières à supprimer :")
        layout = QVBoxLayout() 

        layout.addWidget(label)
        dialog.setLayout(layout)
    
        #On commence par définir une liste vide qui contiendra toute les expressions à supprimer
        regex_inputs = []

        if regex_list is not None: #Si la liste est définie, on ajoute les expressions à la liste
            for regex in regex_list:

                regex_input = QLineEdit()
                regex_input.setText(regex)
                layout.addWidget(regex_input)
                regex_inputs.append(regex_input)
    
    

#boîte de dialogue pour ajouter ou supprimer des expressions 
        def add_regex_input():
            regex_input = QLineEdit()
            layout.addWidget( regex_input )
            regex_inputs.append( regex_input)
    
        #Nis regles d'interface graphique pour la suppression des expressions régulières inutiles
        remove_button = QPushButton("Supprimer")
        layout.addWidget( remove_button)
        remove_button.clicked.connect( dialog.accept)
    
        btn_add_regex = QPushButton("Ajout d'une expression à supprimer")
        btn_add_regex.clicked.connect(add_regex_input)
        layout.addWidget( btn_add_regex )
    
        if dialog.exec_()== QDialog.Accepted: #Si l'utilisateur a cliqué sur le bouton "Supprimer", on supprime les expressions régulières inutiles
            regex_list   = [regex_input.text() for regex_input in regex_inputs]

        else:
            return
        
        
        #On compile toute les formes, les patterns d 'expressions régulières choisies
        regex_patterns =  [re.compile(regex) for regex in regex_list]
    
        #On recherche tout les fichiers dans tout les dossiers du dossier selectionné
        for subdir, _, files in os.walk(folder):
            for filename in files:
                
                new_filename =  filename

                #On applique toutes les expressions régulières a notre nouveau nom de fichie
                for regex in regex_patterns:
                    new_filename = regex.sub('', new_filename)

                #On définit les nouveau chemins
                if new_filename != filename: 
                    old_path = os.path.join(subdir, filename)
                    new_path = os.path.join(subdir, new_filename)
    
                    if os.path.exists(new_path):
                        #Le fichier existe déjà, renommer le fichier avec un nom unique définit par la fonction plus haut
                        new_name = self.get_unique_filename(subdir, new_filename)
                        new_path = os.path.join(subdir, new_name)

                    #Puis on finit en remplacant l'ancien chemin par le nouveau
                    os.rename(old_path, new_path)
                

                

                
        #On terminera en affichant un pop up expliquant que le script a bien fonctionné.
        QMessageBox.information(self, "Information", "Je suis entrain de trier correctement supprimer tout ca.")
                

                

#_    _ ____ ___    _  _ ____ _  _ _ _  _ ____ 
#|    | [__   |     |\/| |__| |_/  | |\ | | __ 
#|___ | ___]  |     |  | |  | | \_ | | \| |__]    
# 
                

#On va mmaintenant reprendre le nom de chaque images et les inscrire dans un tableau excel
    def listing(self):
        #Selection du dossier
        self.select_folder()
                
        if not folder:
            return
                
        # Créer la liste des fichiers d'images
        images = []
        for subdir, _, files in os.walk(folder):
            for file in files:
                if any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                    images.append(os.path.join(subdir, file))
                
        #On enregistre notre liste dans un nouveau fichier de type tableur csv
        with open(os.path.join(folder, os.path.basename(folder)+".csv"), "w", newline="", encoding="utf-8") as f:

            writer = csv.writer(f)
            #Décommenter pour rajouter les noms de colonne suivant:
            #writer.writerow(['Dossier', 'numéro', 'nom', 'taille', 'prix', 'filigrane', 'extension'])

            for image in images:
                filename = os.path.basename(image)
                filename = re.sub(r'\.', ',', filename) # Remplacer tous les '.' par des ','
                filename_parts = filename.split(',')

                writer.writerow(filename_parts)
                
        # Écrire une liste pour chaque dossier
        create_lists = QMessageBox()
        create_lists.setWindowTitle("Créer une liste pour chaque dossier ?")
        create_lists.setText("Voulez-vous créer une liste de fichiers pour chaque dossier dans le répertoire sélectionné ?")


        #On créer une checkbox pour inclure chaque dossier ou non pour éviter de se retrouver avec 8080 listes
        create_lists.setStandardButtons(QMessageBox.Yes | QMessageBox.No) 

        checkbox = QCheckBox("Créer également une liste pour chaque sous-dossiers ?")
        create_lists.setCheckBox(checkbox)
                
        result= create_lists.exec_()

        if result==QMessageBox.Yes:
            include_subdirs= checkbox.isChecked()

        else:
            include_subdirs = False
                
        if include_subdirs:
            for subdir, _, _ in os.walk( folder): 
                images = []

                for file in os.listdir(subdir):
                    if any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                        images.append(os.path.join(subdir, file))
                
                if images:
                    #Ecriture de la liste dans un fichier CSV
                    with open(os.path.join(subdir, os.path.basename(subdir)+ ".csv"), "w", newline="",   encoding="utf-8") as f:

                        writer = csv.writer(f)
                        #Décommenter pour rajouter les noms de colonne suivant:
                        #writer.writerow(['Dossier', 'numéro', 'nom', 'taille', 'prix', 'filigrane', 'extension'])

                        for image in images:

                            filename = os.path.basename(image)
                            filename = re.sub(r'\.', ',', filename) # Remplacer tous les '.' par des ','
                            filename_parts = filename.split(',')

                            writer.writerow(filename_parts)
                
            QMessageBox.information(self, "Opération terminée", "La création des fichiers CSV est terminée.")
                

                



       
#____ ____ _  _ ____ _  _ ____ ____ 
#|__/ |___ |\ | |__| |\/| |___ |__/ 
#|  \ |___ | \| |  | |  | |___ |  \ 
                
#Cette fonction vous aidera a renommer toute les images contenus dans les dossiers et sous-dossiers
#par une suite de nombre : 1 2 3 ....
                
    def rename(self):
        self.select_folder()

        try:
            for subdir, _, files in os.walk(self.folder):
                #On établit notre compteur a 1 a chaque fois qu'il recherche dans un autre dossier
                counter = 1

                try :
                    for filename in files:
                        extension = os.path.splitext(filename)[1].lower()

                        try:#Si un dossier contient une image possedant une extension contenue (dans la liste suivante établie par GPT-3 (merci encore OpenAI))
                            if extension in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf'] :
                                try:
                                    new_name = str(counter) + extension
                                    #On rajoute +1 au compteur qui sera également son nom
                                    counter += 1

                                    old = os.path.join(subdir, filename)

                                except Exception as e:
                                    self.ERRORS("J'ai perdu le chemin d'une image", e)
                                    return     
                                                            
                                try:
                                    new = os.path.join(subdir, new_name)

                                    os.rename(old, new)

                                except Exception as e:
                                    self.ERRORS("Je n'arrive pas à renommer une image", e)
                                    return 
                        
                        except Exception as e:
                            self.ERRORS("Une extension pose problème", e)
                            return 
                        
                except Exception as e:
                    self.ERRORS("un fichier pose problème", e)
                    return 
        
  
        except Exception as e:
            self.ERRORS("Un dossier pose problème", e)
            return 
        





        QMessageBox.information(self, "Information", "toute les images ont été renommées")




#____ ____ ____ ___  _  _ _ ____ ____ _       _  _ ____ ____ ____    _ _  _ ___ ____ ____ ____ ____ ____ ____ 
#| __ |__/ |__| |__] |__| | |    |__| |       |  | [__  |___ |__/    | |\ |  |  |___ |__/ |___ |__| |    |___ 
#|__] |  \ |  | |    |  | | |___ |  | |___    |__| ___] |___ |  \    | | \|  |  |___ |  \ |    |  | |___ |___ 
                

#On passe mainteant à la création de la fenetre utilisateur principale:
                
    def GUI(self):
        
        #Ici on définit les parametres principaux de notre fenetre
        self.setMinimumSize(250,800)
        self.setWindowTitle("TRIEUR") 
        self.setWindowIcon(QIcon(ressource_path(r"ico\trieur.png"))) #Notre logo à l'emplacement relatif au dossier d'execution
                

        #Le bouton pour le darkmode, munis de son identifiant CSS
        self.btn_d4rk = QPushButton("Light Mode", self, objectName="roronoe")
        self.btn_d4rk.setCheckable(True)
        self.btn_d4rk.setChecked(self.mode == 'dark') #On regarde quel mode on est 
        self.btn_d4rk.clicked.connect(self.dark_mode)

        #Un bouton récupérant l'objet d'une classe
        self.oneforall = btn_for_one() 

        #Bouton de suppression d'éléments présent dans le nom
        self.regex_remover = QPushButton("Supprimer des mots", self, objectName="regex")
        self.regex_remover.clicked.connect(self.remove_regex)

        #Bouton pour renommer avec ou sans le prix selon la cote AKOUN
        self.price_maker = QPushButton("Renommer avec cote AKOUN", self, objectName="price")
        self.price_maker.clicked.connect(self.price_making)
        
        #Bouton pour rajouter du texte dans les images
        self.fili = Filigrane()

        #Bouton pour créer une liste/ un tableau
        self.list_files = QPushButton("Lister les images", self, objectName="lists")
        self.list_files.clicked.connect(self.listing)

        #Bouton pour générer des noms aléatoires
        self.randonamer = randonaming()

        #Bouton pour renommer les images
        self.img_renamer = ImageRenamer()  

        #Bouton pour renommer selon une suite 1 2 3...
        self.renamer = QPushButton("Renommer 1.2..3...", self, objectName="rename")
        self.renamer.clicked.connect(self.rename)



        #On créer cette variable pour que le zoom n'affecte que notre page html
        self.webview = QWebEngineView()

        #Affichage d'une page html pour le tuto 
        self.tuto = QTextBrowser()
        self.tuto.setMinimumSize(180, 300)

        #Maintenant on  définit notre tutoriel en fonction de notre barre de défilement via du HTML
        self.tuto.setOpenExternalLinks(True) #On active le clic sur les liens.

        with open(ressource_path("html/tuto.html"), "r", encoding='utf-8') as f_htm: #on lit la page et on l'affiche
            html = f_htm.read()
            self.tuto.setHtml(html)
   
        #Filtre pour transmettre les événements de la souris à la fenêtre principale et éviter les erreurs
        self.tuto.viewport().installEventFilter(self)
                
    
        #On fini par placer nos élément verticalement dans une grille (QHBoxLayout, a importer pour la gestion horizontale)
        lay_trieur = QVBoxLayout()
        
        lay_trieur.addSpacing(10)
        lay_trieur.addWidget(self.btn_d4rk)
        lay_trieur.addWidget(self.oneforall)
        lay_trieur.addWidget(self.regex_remover)
        lay_trieur.addWidget(self.price_maker)
        lay_trieur.addWidget(self.fili)
        lay_trieur.addWidget(self.list_files)
        lay_trieur.addWidget(self.randonamer)
        lay_trieur.addWidget(self.img_renamer)
        lay_trieur.addWidget(self.renamer)
        lay_trieur.addWidget(self.tuto)
        lay_trieur.addSpacing(10)
        
                
        #On centralise les widgets, les éléments que l'on a créé dans notre grille
        widget = QWidget(self)
        widget.setLayout(lay_trieur)
        self.setCentralWidget(widget)
                

        #On affiche le tout
        self.show()
                


                
#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |
                
#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3
                
if __name__ == "__main__":

    app = QApplication(sys.argv)


    #On commence par afficher notre logo le temps de charger la fenetre
    logo_path = ressource_path("ico/Trieur.svg")

    #Création du SplashScreen
    splash_pix = QPixmap(logo_path)
    splash = showlogo(splash_pix) #On joue le logo au dessus de tout le reste
    splash.setAttribute(Qt.WA_QuitOnClose, False)  #On empeche de quitter en cliquant sur la fenêtre


    splash.show()
    
    logger = logging.getLogger(__name__) #créer un logger avec le nom du programme
    logger.setLevel(logging.DEBUG) #Créer un logger avec le niveau de débogage du programme
    handler = logging.FileHandler('error.log') #Créer un gestionnnaire des logs
    handler.setLevel(logging.ERROR) #Créer un niveau de débogage du gestionnaire
    formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s') #Créer un gestionnaire de formatage pour les messages
    handler.setFormatter(formatter) #définit ou effectuer le formatage
    logger.addHandler(handler) #ajoute le gestionnaire au logger             

    window = trieur()

    time.sleep(2) #On attend 1 seconde pour lancer le programme pour flex le logo
    #On ferme le logo apres que la fenetre soit initialisée
    splash.finish(None)

    sys.exit(app.exec_())
