#          ████████     ██████
#         █░░░░░░░░██_██░░░░░░█
#        █░░░░░░░░░░░█░░░░░░░░░█
#       █░░░░░░░███░░░█░░░░░░░░░█
#       █░░░░███░░░███░█░░░████░█
#     █░░░██░░░░░░░░███░██░░░░██
#    █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#    █░░░░░░░░░░░░░██████░░░░░████░░█
#    █░░░░░░░░░█████░░░████░░██░░██░░█
#   ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
#  █░░░░░░░░░░░░░░█████████░░█████████
# █░░░░░░░░░░█████ ████   ████ █████ █
# █░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
# /            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#        \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |
                

#      |               |                                 |
                
#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  |                                     |
                
#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    |
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |
                
#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |
                
#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#           |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#   |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                               |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#                |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
                
#        |                           Cet outils permet de trier des données
                
#                              rapidement pour des artistes cotés AKOUN tels que                      |                                           |               |                                           |               |                                           |                    |                                           |
                
#                           /                      |    v    |                    \
                
#                   Nathacha , artiste peintre de l'abstraction https://www.artnathacha.com/                |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |
#                                                                                                    |                                                                 |                      |                     |                       |                      |                     |                       |                      |                     |                            |
#      |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                                |                                   |     |                  
#                   |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |
                
#              |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |
                

#                 |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |
                
#                                                         =)
                
#
#                                |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |
                

#              |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#      |                        |                                         |                                |
                
#
#                                                     !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |
                
#      |               |                                 !
                
#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  !                                     |
                
#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    !
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
                
#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |
                
#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#           |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |
                
#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|
                

import os, re, sys, csv, logging

from PIL import Image
from unidecode import unidecode

from PyQt5.QtCore import Qt
from PyQt5.QtWidgets import QApplication, QPushButton, QFileDialog, QLabel, QLineEdit, QCheckBox,QVBoxLayout, QWidget, QMessageBox,QDialog

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |
                

#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3
                


#Création d'une classe contenant nos fonctions et boutons principaux
class all_for_one(QDialog):
    def __init__(self):
        super().__init__()
                
        self.folder = None

        self.setWindowTitle("Confirmation")
        
        self.lab_sure = QLabel(self)
        self.lab_sure.setText("Etes-vous sûr de continuer ? Je ne m'arrêterai pas avant d'avoir exécuté l'ensemble des tâches suivantes : \n\n"
                       "0. Sélectionner l'ensemble des fichiers contenus dans les dossiers et sous-dossiers d'un même répertoire.\n"
                       "1. Supprimer les mots inutiles des noms des fichiers.\n"
                       "2. Renommer les fichiers avec un prix ou non, défini par la cote AKOUN.\n"
                       "3. Créer une liste/un tableau excel (.csv)")
        
        self.lets_go = QPushButton("Continuer", self)
        self.lets_go.clicked.connect(self.accept)
        
        self.lets_nope = QPushButton("Revenir en arrière", self)
        self.lets_nope.clicked.connect(self.reject)
        
        self.lay_a4o = QVBoxLayout(self)
        self.lay_a4o.addWidget(self.lab_sure)
        self.lay_a4o.addWidget(self.lets_go)
        self.lay_a4o.addWidget(self.lets_nope)

#___  _  _ ____ ____ 
#|__] |  | | __ [__  
#|__] |__| |__] ___] 
                    
#La première concernera la gestion des erreurs dans l'application
                
#Fonction pour les erreurs au sein des autres fonctions
    def ERRORS(self, message, exception=None):
                
        alert = QMessageBox()
        alert.setWindowTitle("GAME OVER")
        alert.setText(message)
        alert.setIcon(QMessageBox.Warning)
                
        alert_button = alert.addButton("Ca coince ici !", QMessageBox.ActionRole)
                
        alert.exec_()
                
        if alert.clickedButton() == alert_button and alert_button.text() == "Ca coince ici !" and exception is not None:
            logger.error(str(exception), exc_info=True)
            os.startfile('error.log')
                

                

#Fonction pour rechercher si des fichiers ne sont pas au bon format
    def NOPE(self, folder):
                
    #On commence par définir les extensions supportées
        ext_SUPPORTED = {'.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg','.pcd', 
                         '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif','.tiff', '.xbm',
                         '.xpm', '.txt', '.text','.csv'}
                
    #Une liste vide qui contiendra nos chemins vers les images à dégager
        non_supported_files = []
    #On recherche dans tout les dossiers/ sous dossiers du dossier selectionné
        for subdir, _, files in os.walk(folder): #le "_" sert a dire que la variable n'est pas utilisé (en l'occurence on parle ici du répertoire des dossiers), c'est pour aléger la mémoire pour rien.
            for file in files:
                

                filename, extension = os.path.splitext(file)
                
                #Si des fichiers dont les extensions ne sont pas supportées,
                if extension.lower() not in ext_SUPPORTED:
                    #On ajoute ces fichiers dans notre liste
                    non_supported_files.append(os.path.join(subdir, file))
                
        if non_supported_files:
                
            A_NOPE = QMessageBox()
                
            A_NOPE.setWindowTitle("SHhhTOP!")
            A_NOPE.setText(f"Je ne supporte pas ce type de fichier: \n\n{chr(10).join(non_supported_files)}\n\n"
                           f"Je ne traite que les formats suivant : \n.bmp, .png, .jpg, .dib, .dcx, .gif, .im, .jpe, .jpeg, .pcd, .pcx, .png, .pbm, .pgm, .ppm, .psd, .tif, .tiff, .xbm, ou .xpm ")
            A_NOPE.setIcon(QMessageBox.Warning)
            
            btn_yes = A_NOPE.addButton("LANCER QUAND MEME !", QMessageBox.AcceptRole)
                
            A_NOPE.exec_()
                
            if A_NOPE.clickedButton() == btn_yes:
                return True
                
        return True #Permet de continuer puisque le message d'erreur n'est qu'a titre informatif
                

                
#____ ____ _    ____ ____ ___ _ ____ _  _ 
#[__  |___ |    |___ |     |  | |  | |\ | 
#___] |___ |___ |___ |___  |  | |__| | \| 
                                         
                

#Maintenant notre fonction pour appeler les dossiers qu'on réutilisera un peu partout
    def select_folder(self):
                
        global folder
                
        try:
            options = QFileDialog.Options()
            options |= QFileDialog.ReadOnly 
            folder = QFileDialog.getExistingDirectory(self, "Selectionnez un dossier", "",options=options) 
                
            #Cette partie sert à éviter les erreurs de selection de dossier 
            if folder:      
                if not self.NOPE(folder):
                    return        
            self.folder = folder
                
            if not folder: 
                return None
                
            # Vérifier que le dossier est valide et enregistrer le chemin du dossier
            if not self.check_folder(folder):
                return None            
                
            return self.folder
                
        except Exception as e:
            self.ERRORS("Je n'arrive pas à ouvrir le dossier \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return
                

    def check_folder(self, folder):
        # Vérifier que le dossier existe et qu'il contient des fichiers
        if not os.path.isdir(folder):
            self.ERRORS("Ce n'est pas un dossier.")
            return False
        
        if not os.listdir(folder):
            self.ERRORS("Le dossier est vide.")
            return False
        return True
                

                

                
#___  ____ _ ____ ____    _  _ ____ _  _ ____ ____ 
#|__] |__/ | |    |___    |\/| |__| |_/  |___ |__/ 
#|    |  \ | |___ |___    |  | |  | | \_ |___ |  \ 
                

                
#Ici, nous allons définir comment créer une liste à partir des fichiers d'un dossier et de ses sous-dossiers. 
#Cela permettra de créer différentes listes, y compris une les regroupant.
                

#Fonction pour renommer correctement nos images pour la suite :
    def img_rename(self):
                
        #Ici on demande au systeme de stocker dans une variables "files" le chemin de tout les fichiers dans le dossier choisi (sous dossiers inclus)
        files = [f for f in os.listdir(self.folder) if os.path.isfile(os.path.join(self.folder, f)) ] 
                
        #Création de la boucle de recherche dans tout les (sous)dossiers
        for subdir, _, files in os.walk( self.folder):
            for file in  files:
                
                old = os.path.join(subdir, file) #Notre variable contenant les noms des anciens fichiers 
                filename, extension = os.path.splitext(file) #Séparation du nom de l'extension
                
                #Remplacement des caractères spéciaux par des espaces, des lettres accentuées par leur correspondance ("è" devient "e") avec unidecode
                new_file = re.sub(r'[^a-zA-Z0-9]+', ' ', unidecode(filename)) 
                new_file = re.sub("^\d+\s", "", new_file) # Supprime le premier nombre (si les images sont numérotées dans le nom pour éviter les erreurs futures)

                #Ce qui suit n'est plus particulierement utile puisque j'ai modifier l'expression de recherche des tailles :
                new_file = re.sub(r'([0-9])X', r'\1x', new_file) # Transforme les X majuscules après un nombre (entre 0 et 9), en x minuscule
                new_file = re.sub(r'(\d)\s*x\s*(\d)', r'\1x\2', new_file, flags=re.IGNORECASE) #Supprime les espaces autour des x
                new_file = re.sub(r'(\d)\s*cm', r'\1cm', new_file, flags=re.IGNORECASE) #Supprime les espaces à gauche des cm
                new_file = re.sub(r'(\d)\s*x\s*(\d)', r'\1x\2', new_file, flags=re.IGNORECASE)
                
                #On va de nouveau renomme, mais cette fois on supprime les mots ressemblant au nom du dossier ouvert, mais au """singulier""".
                for subfolder in os.path.relpath(subdir, folder).split(os.sep):
                    if subfolder != '.':
                        singular = subfolder[:-1] if subfolder.endswith('s') else subfolder #On définit que singulier = sans s (flemme <3)
                        new_file = re.sub(subfolder, '', new_file, flags=re.IGNORECASE) # Supprime les mots ressemblants au nom du dossier
                        new_file = re.sub(singular, '', new_file, flags=re.IGNORECASE) #Supprime les mots ressemblants au nom du dossier au singulier
                #Renommage du fichier
                new = os.path.join(subdir, new_file + extension)
                
                # Vérifier si le fichier existe déjà dans le dossier
                while  os.path.exists(new):
                    # Générer un nouveau nom de fichier unique
                    new_file = new_file + "_1"
                    new= os.path.join(subdir, new_file + extension)
                
                os.rename(old, new)
                

                
#Pop up pour demander la cote akoun
    def demander_cote_akoun(self):
                
        #Créer la pop-up pour demander la cote AKOUN
        pop_akoun = QMessageBox()
        pop_akoun.setWindowTitle("Entrez votre cote AKOUN")
                
        #Label pour le texte
        label = QLabel("Entrez votre cote AKOUN (maximum 7 chiffres) :")
        label.setAlignment(Qt.AlignCenter)
                
        #Demande d'entrer la cote AKOUN
        champ_texte = QLineEdit()
        champ_texte.setMaxLength(7)
                
        #Répartition des éléments à la pop-up
        layout =pop_akoun.layout()
        layout.addWidget(label, 0, 0)
        layout.addWidget(champ_texte, 1, 0)
        pop_akoun.setLayout(layout)
                
        btn_launch   = pop_akoun.exec_()
                
        #Si le bouton OK a été cliqué mais qu'il ne contient rien,ou qu'on a annulé l'opération, on revient en arriere
        if btn_launch ==  QMessageBox.RejectRole or champ_texte.text() == "":
            return 
                
        #Sinon ciao
        else:
            return int(champ_texte.text()) # Sinpn on revient en arriere avec la cote enregistrée.
                

                

#Fonction pour enregistrer le prix dans les images du dossier choisi (sous dossiers inclus)             
    def image_formatter(self):
        subdirs = []
        cote_akoun = self.demander_cote_akoun() 
        try:
            for subdir, _, _ in os.walk(self.folder):
                subdirs.append(subdir)  
                
                image_infos = []  # initialisation de la liste "image_infos"
                size = "" 
                
                for file in os.listdir(subdir): #On regarde les extensions pour éviter les erreurs de formatage
                    if not any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                        continue
                
                    #on récupère les informations de chaque image
                    image_info = {"num": len(image_infos) + 1}
                    image_infos.append(image_info)  # ajout de "image_info" à la liste "image_infos"
                    image_info["type"] = os.path.basename(subdir) 
                
                    with Image.open(os.path.join(subdir, file)) as picture:
                        sizes = re.findall(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', file.lower()) #On regarde si il y a des expressions de taille de chaque image



                        if sizes: #Si il y en a
                            try:
                                image_info["longueur"] = int(sizes[0][0]) #on les sauvegarde dans des tableaux, le premier 0 définissant la ligne, le 2eme la colone
                                image_info["hauteur"] = int(sizes[0][1]) 
                                image_info["profondeur"] = int(sizes[0][2]) if sizes[0][2] else 1 #Si il n'y a pas de profondeur, on le sauvegarde en 1
                
                                if image_info["profondeur"] == 1 : #Si la profondeur est 1 on la supprime de la taille
                                    size = f"{image_info['longueur']}x{image_info['hauteur']}"
                                else :
                                    size = f"{image_info['longueur']}x{image_info['hauteur']}x{image_info['profondeur']}"   
                
                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec {picture.filename}", e)

                        else: #Si il n'y en a pas on va convertir les pixels en cm
                            try:

                                width, height =  picture.size 
                                Image.MAX_IMAGE_PIXELS = None #on évite la limite de taille d'image imposée par python

                                dpi = picture.info.get("dpi", (300, 300)) #Applique 300 dpi par défaut si on a pas les info sur la résolution
                                width_cm = round(width / dpi[0] * 2.54) #2.54 est le ratio standard
                                height_cm = round(height / dpi[1] * 2.54)

                                image_info["longueur"] = width_cm
                                image_info["hauteur"] = height_cm
                                image_info["profondeur"] = 1 #On met la profondeur à 1 pour que la taille de l'image soit calculée

                                size = f"{image_info['longueur']}x{image_info['hauteur']}" 
                
                            except Exception as e:
                                self.ERRORS("Il y a un probleme concernant la résolution des images, ou leur taille \n\n je vais tenter d'appliquer un ratio standard (1cm = 37.79527559055 pixels) \n\n Ce ne sera pas super précis, il vaudrait mieux modifier les images et recommencer", e)
                                try : #Si le calcul via les DPI ne fonctionne pas, on essaie calcul a l'aide d'un ratio fixe.

                                    width, height =  picture.size 
                                    Image.MAX_IMAGE_PIXELS = None
                                    width, height = picture.size 

                                    ratio = 37.79527559055 

                                    width_cm = round(width / ratio)
                                    height_cm = round(height / ratio)

                                    image_info["longueur"] = width_cm
                                    image_info["hauteur"] = height_cm
                                    image_info["profondeur"] = 1

                                    size = f"{image_info['longueur']}x{image_info['hauteur']}" 

                                except Exception as e:
                                    self.ERRORS("Il y a un serieux probleme avec les metadonnées de {picture.filename}, \n\n Je n'arrive pas à récupérer les informations de longueur x largeur pour les transformer, elles semblent corrompues", e)
                                    return 
                        


                    if cote_akoun is not None and cote_akoun > 0: #On vérifie si la cote_akoun est valide au quel cas on applique le calcul suivant pour trouver son prix ((longueur x hauteur x profondeur)*cote akoun /3250)

                
                        prix =  round((image_info["longueur"]*image_info["hauteur"]*image_info["profondeur"]*cote_akoun)/3250) 
                
                    #on récupere l'ancien nom et on le modifie en le séparant d'abord de l'extension puis en supprimant les anciennes valeurs de tailles pour ne pas les avoir en double par la suite
                    old_path = os.path.join(subdir, file)
                    old_name, extension = os.path.splitext(file) 
                    old_name = re.sub(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', '', old_name, flags=re.IGNORECASE).strip()
                
                    #On renomme avec le nouveau prix si l'utilisateur a utilisé une cote, sinon on renomme sans le prix
                    if cote_akoun is not None and cote_akoun > 0: 
                        new_name = f"{image_info['type']},{str(image_info['num']).zfill(5)},{old_name},{size}cm,{str(prix)}€{extension}"

                    #Par ailleurs, on sépare le nom avec des "," pour mots-clés ou pour faire un tableau plus tard, et on rajoute des 0 devant le numéro pour le repérer facilement au besoin plus tard.
                    
                    else :
                        new_name = f"{image_info['type']},{str(image_info['num']).zfill(5)},{old_name},{size}cm,{extension}"    
                
                    new_path = os.path.join(subdir, new_name)
                
                    # on renomme le fichier
                    try:
                        os.rename(old_path, new_path)
                    except Exception as e:
                        self.ERRORS(f"Je n'arrive pas à renommer le fichier {old_path}", e)
                

        except Exception as e:
            self.ERRORS("Je n'arrive pas à formater les images", e)
    
                

                                
#Fonction permettant de cleaner le nom des images ainsi que les futures listes
    def cleaner(self):
        for subdir, _, files in os.walk(self.folder):
            for file in files:
                
                #Vérification si le nom de fichier esst bien dans une liste
                if file in ('0list.txt', 'ALL_IN.txt'):
                    file_path = os.path.join(subdir, file)
                
                    #Suppression des données de type "90x90cm..." ou les doubles espaces,... on encode le format en UTF-8 pour que ce soit lu par python et résoudre les problemes de compatibilité
                    with open(file_path, "r", encoding="utf8") as f:
                        lines = f.readlines()
                
                    with open(file_path, "w", encoding="utf8") as f:
                        for line in lines:

                            new_line = re.sub(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', '', line.lower())
                            new_line = re.sub(r'(\s{2,})', ' ', new_line).strip() + '\n' 
                            
                            if new_line.strip() or line.strip(): #vérifie si les lignes sont vides ou non
                                f.write(new_line)

                                


                
#___  ____ _    ____ ___ ____    ____ ____ ____ _  _ _    ____ ____    ____ _  _ ___  ____ ____ ____ ____ _ ____ _  _ ____ 
#|  \ |___ |    |___  |  |___    |__/ |___ | __ |  | |    |__| |__/    |___  \/  |__] |__/ |___ [__  [__  | |  | |\ | [__  
#|__/ |___ |___ |___  |  |___    |  \ |___ |__] |__| |___ |  | |  \    |___ _/\_ |    |  \ |___ ___] ___] | |__| | \| ___] 
                                                                                                                          
                
#Ici on va s'attaquer aux expressions régulières dans le nom des fichiers
#On commence par selectionner le dossier via une fonction de recherche
    def remove_regex(self):
                
        regex_list = []
 
        self.rem_regex(folder, regex_list) 
                

                

#Une fonction évitant les erreurs dans les fichiers, on ajoute un numéro aux images renommées avec un meme nom qu'une autre
    def get_unique_filename(self,folder,filename):

        base, ext = os.path.splitext(filename)
        num = 1
        new_name = filename

        while os.path.exists(os.path.join(folder,new_name)):

            new_name = f"{base}__NOM EN DOUBLE{num}__{ext}" #On ajoute "nom en double +1 numero" avant l'extension
            num += 1

        return new_name
    
                
                

#Maintenant on va créer une interface graphique dans un pop up pour demander la suppression des expressions régulières inutiles      
    def rem_regex(self, folder,regex_list=None)  :
        #Afficher un popup pour demander l'expression régulière à supprimer
        dialog = QDialog(self)
    
        dialog.setWindowTitle("Supprimer une expression régulière")
        label = QLabel("Entrez les expressions régulières à supprimer :")
        layout = QVBoxLayout() 

        layout.addWidget(label)
        dialog.setLayout(layout)
    
        #On commence par définir une liste vide qui contiendra toute les expressions à supprimer
        regex_inputs = []

        if regex_list is not None: #Si la liste est définie, on ajoute les expressions à la liste
            for regex in regex_list:

                regex_input = QLineEdit()
                regex_input.setText(regex)
                layout.addWidget(regex_input)
                regex_inputs.append(regex_input)
    
    

#boîte de dialogue pour ajouter ou supprimer des expressions 
        def add_regex_input():
            regex_input = QLineEdit()
            layout.addWidget( regex_input )
            regex_inputs.append( regex_input)
    
        #Nis regles d'interface graphique pour la suppression des expressions régulières inutiles
        remove_button = QPushButton("Supprimer")
        layout.addWidget( remove_button)
        remove_button.clicked.connect( dialog.accept)
    
        btn_add_regex = QPushButton("Ajout d'une expression à supprimer")
        btn_add_regex.clicked.connect(add_regex_input)
        layout.addWidget( btn_add_regex )
    
        if dialog.exec_()== QDialog.Accepted: #Si l'utilisateur a cliqué sur le bouton "Supprimer", on supprime les expressions régulières inutiles
            regex_list   = [regex_input.text() for regex_input in regex_inputs]

        else:
            return
        
        
        #On compile toute les formes, les patterns d 'expressions régulières choisies
        regex_patterns =  [re.compile(regex) for regex in regex_list]
    
        #On recherche tout les fichiers dans tout les dossiers du dossier selectionné
        for subdir, _, files in os.walk(folder):
            for filename in files:
                
                new_filename =  filename

                #On applique toutes les expressions régulières a notre nouveau nom de fichie
                for regex in regex_patterns:
                    new_filename = regex.sub('', new_filename)

                #On définit les nouveau chemins
                if new_filename != filename: 
                    old_path = os.path.join(subdir, filename)
                    new_path = os.path.join(subdir, new_filename)
    
                    if os.path.exists(new_path):
                        #Le fichier existe déjà, renommer le fichier avec un nom unique définit par la fonction plus haut
                        new_name = self.get_unique_filename(subdir, new_filename)
                        new_path = os.path.join(subdir, new_name)

                    #Puis on finit en remplacant l'ancien chemin par le nouveau
                    os.rename(old_path, new_path)
                

                

                
        #On terminera en affichant un pop up expliquant que le script a bien fonctionné.
        QMessageBox.information(self, "Information", "Je suis entrain de trier correctement supprimer tout ca.")
                

                

#_    _ ____ ___    _  _ ____ _  _ _ _  _ ____ 
#|    | [__   |     |\/| |__| |_/  | |\ | | __ 
#|___ | ___]  |     |  | |  | | \_ | | \| |__]    
# 
                

#On va mmaintenant reprendre le nom de chaque images et les inscrire dans un tableau excel
    def listing(self):

        # Créer la liste des fichiers d'images
        images = []
        for subdir, _, files in os.walk(folder):
            for file in files:
                if any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                    images.append(os.path.join(subdir, file))
                
        #On enregistre notre liste dans un nouveau fichier de type tableur csv
        with open(os.path.join(folder, os.path.basename(folder)+".csv"), "w", newline="", encoding="utf-8") as f:

            writer = csv.writer(f)
            writer.writerow(['Dossier', 'numéro', 'nom', 'taille', 'prix', 'filigrane', 'extension'])

            for image in images:
                filename = os.path.basename(image)
                filename = re.sub(r'\.', ',', filename) # Remplacer tous les '.' par des ','
                filename_parts = filename.split(',')

                writer.writerow(filename_parts)
                
        # Écrire une liste pour chaque dossier
        create_lists = QMessageBox()
        create_lists.setWindowTitle("Créer une liste pour chaque dossier ?")
        create_lists.setText("Voulez-vous créer une liste de fichiers pour chaque dossier dans le répertoire sélectionné ?")


        #On créer une checkbox pour inclure chaque dossier ou non pour éviter de se retrouver avec 8080 listes
        create_lists.setStandardButtons(QMessageBox.Yes | QMessageBox.No) 

        checkbox = QCheckBox("Créer également une liste pour chaque sous-dossiers ?")
        create_lists.setCheckBox(checkbox)
                
        result= create_lists.exec_()

        if result==QMessageBox.Yes:
            include_subdirs= checkbox.isChecked()

        else:
            include_subdirs = False
                
        if include_subdirs:
            for subdir, _, _ in os.walk( folder): 
                images = []

                for file in os.listdir(subdir):
                    if any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                        images.append(os.path.join(subdir, file))
                
                if images:
                    #Ecriture de la liste dans un fichier CSV
                    with open(os.path.join(subdir, os.path.basename(subdir)+ ".csv"), "w", newline="",   encoding="utf-8") as f:

                        writer = csv.writer(f)
                        writer.writerow(['Dossier', 'numéro', 'nom','taille', 'prix', 'filigrane','extension'] )

                        for image in images:

                            filename = os.path.basename(image)
                            filename = re.sub(r'\.', ',', filename) # Remplacer tous les '.' par des ','
                            filename_parts = filename.split(',')

                            writer.writerow(filename_parts)
                
            QMessageBox.information(self, "Opération terminée", "La création des fichiers CSV est terminée.")
                

                



#Maintenant qu'on a établi toute nos fonctions, on les fait se jouer une par une à l'aide d'un index appelé par l'utilisateur
    def GO (self):
                
        #Selection du dossier
        self.select_folder()
        if not folder: 
            return

        #Supprimer les expressions régulières
        self.remove_regex()

        #Selection du dossier
        self.img_rename()
                
        #Appel la fonction d'enregistrement des listes
        self.image_formatter()
                
        #Appel de la fonction pour cleaner les listes        
        self.cleaner()

        #Créer une liste pour chaque dossiers
        self.listing()


        QMessageBox.information(self,"Information", "Le tri s'est bien effectué. \n J'ai créé la liste dans le dossier concerné")
                






                
#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |
                
#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3
                
if __name__ == "__main__":


    logger = logging.getLogger(__name__) #créer un logger avec le nom du programme
    logger.setLevel(logging.DEBUG) #Créer un logger avec le niveau de débogage du programme
    handler = logging.FileHandler('error.log') #Créer un gestionnnaire des logs
    handler.setLevel(logging.ERROR) #Créer un niveau de débogage du gestionnaire
    formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s') #Créer un gestionnaire de formatage pour les messages
    handler.setFormatter(formatter) #définit ou effectuer le formatage
    logger.addHandler(handler) #ajoute le gestionnaire au logger             


    app = QApplication(sys.argv)
    dialog = all_for_one()

    #Si on accepte la fonction continue, sinon on ferme le programme
    if dialog.exec() == QDialog.Accepted:
        dialog.GO()
        sys.exit(app.exec_())
    else :
        sys.exit()

