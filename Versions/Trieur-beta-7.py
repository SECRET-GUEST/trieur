#          ████████     ██████
#         █░░░░░░░░██_██░░░░░░█
#        █░░░░░░░░░░░█░░░░░░░░░█
#       █░░░░░░░███░░░█░░░░░░░░░█
#       █░░░░███░░░███░█░░░████░█
#     █░░░██░░░░░░░░███░██░░░░██
#    █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#    █░░░░░░░░░░░░░██████░░░░░████░░█
#    █░░░░░░░░░█████░░░████░░██░░██░░█
#   ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
#  █░░░░░░░░░░░░░░█████████░░█████████
# █░░░░░░░░░░█████ ████   ████ █████ █
# █░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
# /            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |

#        \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |


#      |               |                                 |

#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  |                                     |

#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    |
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |

#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |

#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#           |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |

#   |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                               |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#                |                             /                 \                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |

#        |                         Ce trieur permet de calculer le prix plus

#                              rapidement pour des artistes cotés AKOUN tels que                      |                                           |               |                                           |               |                                           |                    |                                           |

#                           /                      |    v    |                    \

#                   Nathacha , artiste peintre de l'abstraction https://www.artnathacha.com/                |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |
#                                                                                                    |                                                                 |                      |                     |                       |                      |                     |                       |                      |                     |                            |
#           Afin d'éviter d'avoir à passer par un tableur, il est possible qu'une IA s'y glisse a terme
#      |                  !      |                                   |     |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |
#                                |                                   |     |                  
#                   |            |                   Anyway          !                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |

#              |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |


#                 |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |

#                                                         =)

#
#                                |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |


#              |                              |       DIE ! ! !        |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#      |                        |                                         |                                |

#
#                                                     !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |

#      |               |                                 !

#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  !                                     |

#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    !
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |

#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |

#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#           |                               |                                         !                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |

#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|


import os,re,sys,logging,configparser

from PIL import Image
from unidecode import unidecode

from PyQt5.QtWidgets import QApplication, QMainWindow, QPushButton, QFileDialog, QLabel, QLineEdit,  QCheckBox, QVBoxLayout, QWidget, QMessageBox, QTextBrowser, qApp, QStyleFactory
from PyQt5.QtGui import QIcon, QWheelEvent
from PyQt5.QtCore import Qt, QFile, QTextStream
from PyQt5.QtWebEngineWidgets import QWebEngineView

#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |


#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3


def ressource_path(relative_path):
    try:
        base_path=sys._MEIPASS

    except Exception:
        base_path = os.path.abspath('.')

    return os.path.join(base_path ,relative_path)

# Pour que la création d'un fichier executable s'effectue, il faut inclure tout les chemins relatif dans ressource_path()
# Exemple : 
# /icon/lol.png  DEVIENT  ressource_path(/icon/lol.png)
# idem dés que l'on ouvre un fichier relatif en lecture, ou en écriture.


#Création d'une classe contenant nos fonctions et boutons principaux
class trieur(QMainWindow):
    def __init__(self):
        super().__init__()
     
        # Charger le fichier CSS
        script_dir = os.path.dirname(os.path.abspath(__file__))
        css_path = os.path.join(script_dir, ressource_path('css/style.css'))

        # Appliquer la feuille de style globale
        qApp.setStyle(QStyleFactory.create('Fusion'))
        qApp.setStyleSheet(self.load_stylesheet(css_path))

        self.copy_first() # Voila un tuto pour la compréhension de la notion "self" : https://www.edureka.co/blog/self-in-python/#what )
        self.GUI() #On initialise l'interface utilisateur

        #On applique un facteur de zoom pour la fenetre tuto
        self.zoom_factor = 1.0


#On rajoute immédiatement une fonction pour lire notre fichier css        
    def load_stylesheet(self, path):
        file = QFile(path)
        file.open(QFile.ReadOnly | QFile.Text)
        stream = QTextStream(file)
        return stream.readAll()


#Maintenant on va s'occuper de l'ergonomie du tuto
    #Fonction pour gérer le scroll
    def wheelEvent(self, event) :  
        if event.modifiers() == Qt.ControlModifier:#Si la touche ctrl est appuyée
            if  event.angleDelta().y() > 0 :  #si on essaie de zoomer
                self.zoom_in()  #on zoom
    
            elif event.angleDelta().y() < 0 : #et inversement
                self.zoom_out() 

        else:#Sinon on reprends l'utilisation normale de la molette (important pour éviter les erreurs d'impossible de rezoomer / dezoomer)
            super().wheelEvent(event) 


#Fonction pour zoomer    
    def zoom_in(self):
        #Récupére le facteur de zoom actuel
        zoom_factor = self.webview.zoomFactor()

        #Augmenter le zoom
        zoom_factor += 0.1

        #on enregistre le nouveau facteur de zoom
        self.webview.setZoomFactor(zoom_factor)


#Fonction pour dézoomer     
    def zoom_out(self):  
        zoom_factor = self.webview.zoomFactor() 
        zoom_factor -= 0.1 
        self.webview.setZoomFactor(zoom_factor) 
    


#.-=~=-.                                                                       .-=~=-.#
#(__  _)-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-(__  _)#
#( _ __)                                                                       ( _ __)#
#(__  _) Toujours dans notre fenetre, on va maintenant definir les algorithmes (__  _)#
#(__  _)                                                                       (__  _)#
#(_ ___)-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-=-._.-(_ ___)#
#`-._.-'                                                                       `-._.-'#



#___  _  _ ____ ____ 
#|__] |  | | __ [__  
#|__] |__| |__] ___] 
                    
#La première concernera le traitement des erreurs dans l'application

#Fonction pour les erreurs au sein des autres fonctions
    def ERRORS(self, message, exception=None):

        alert = QMessageBox()
        alert.setWindowTitle("GAME OVER")
        alert.setText(message)
        alert.setIcon(QMessageBox.Warning)
        error_show = alert.addButton("Ca coince ici !", QMessageBox.ActionRole)
        alert.exec_()

        if alert.clickedButton() == error_show and exception is not None:
            logger.error(str(exception), exc_info=True)
            os.startfile('error.log')


#Fonction pour rechercher si des fichiers ne sont pas au bon format
    def NOPE(self, folder):

    #On commence par définir les extensions supportées
        ext_SUPPORTED = {'.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg','.pcd', 
                         '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif','.tiff', '.xbm',
                         '.xpm', '.pdf', '.txt', '.text'}

    #Une liste vide qui contiendra nos chemins vers les images à dégager
        non_supported_files = []

    #On recherche dans tout les dossiers/ sous dossiers du dossier selectionné
        for subdir, dirs, files in os.walk(folder):
            for file in files:

                filename, extension = os.path.splitext(file)

                #Si des fichiers dont les extensions ne sont pas supportées,
                if extension.lower() not in ext_SUPPORTED:
                    #On ajoute ces fichiers dans notre liste
                    non_supported_files.append(os.path.join(subdir, file))

        if non_supported_files:

            A_NOPE = QMessageBox()

            A_NOPE.setWindowTitle("SHhhTOP!")
            A_NOPE.setText(f"Je ne supporte pas ce type de fichier: \n\n{chr(10).join(non_supported_files)}\n\n"
                           f"J'EXIGE le retrait, du moins une conversion en .png ou .jpg.\n\n faites au moins une copie du dossier traité, vous risquez de perdre des données sinon.")
            A_NOPE.setIcon(QMessageBox.Warning)
            
            btn_yes = A_NOPE.addButton("LANCER QUAND MEME !", QMessageBox.AcceptRole)
            btn_nope = A_NOPE.addButton("Nope", QMessageBox.RejectRole)

            A_NOPE.exec_()

            if A_NOPE.clickedButton() == btn_yes:
                return True

            elif A_NOPE.clickedButton() == btn_nope:
                return False 
            
        return True


#Ceci est completement facultatif, mais ici on créer un pop up pour notifier l'utilisateur de ne pas oublier de faire une copie des dossiers avant de les manipuler :
    def copy_first(self):
        #On créer un fichier config.ini ou sera stockée la réponse
        config= configparser.ConfigParser()
        config.read('config.ini' ) 

        if 'General' not in config.sections():
            config.add_section('General')

        disclaimer =config.getboolean('General', 'disclaimer', fallback=True)

        #Affichage du disclaimer dans un popup
        if disclaimer:

            msgBox=QMessageBox()
            msgBox.setText("PENSEZ A CREER UNE COPIE DE VOS FICHIERS AVANT DE LES MANIPULER")
            checkbox= QCheckBox("Ne plus afficher au démarrage")
            msgBox.setCheckBox(checkbox)

            reply = msgBox.exec_()

            # Enregistrement des préférences de l'utilisateur dans le fichier de configuration
            config.set('General','disclaimer', str(not checkbox.isChecked()))

            with open('config.ini', 'w') as configfile:
                config.write(configfile)

#_    _ ____ ___    _  _ ____ _  _ _ _  _ ____ 
#|    | [__   |     |\/| |__| |_/  | |\ | | __ 
#|___ | ___]  |     |  | |  | | \_ | | \| |__]    
# 


#Ici, nous allons définir comment créer une liste à partir des fichiers d'un dossier et de ses sous-dossiers. 
#Cela permettra de créer différentes listes, y compris une les regroupant.



#Commencons avec 2 fonctions pour enregistrer les listes

#Fonction d'enregistrement des liste inhérente au dossier ouvert (0list.txt) :
    def save_list(self, image_infos, filepath):
        with open(filepath, "w", encoding="utf8") as file:
            for image_info in image_infos:
                    line = "{num} {type} {longueur} {hauteur} {profondeur} {nom}\n".format(**image_info) 
                    
                    file.write(line) # On recommence à la ligne pour chaque nouvelle image




#Fonction d'enregistrement de la liste qui regroupe toute les listes de tout les dossiers (All_IN.txt)
    def all_for_one(self, folder, filepath):
        allin = []

    #Bon pour le reste, il suffit de lire, la fonction recupère tout les fichiers .txt de tout les (sous)dossiers, et bref ... 
        for subdir, dirs, files in os.walk(folder):
            for file in files:
                if file.endswith('.txt') :
                    with open(os.path.join(subdir, file), 'r') as all: #r = lecture seule
                        for line in all:
                            allin.append(line)

        with open(filepath, 'a', encoding="utf8") as f:  #a = append (s'ajoute à ..)
            for line in allin:
                f.write(line)





#Fonction principale :
    def list_making(self):


#Fonction permettant de cleaner le nom des images ainsi que les futures listes
        def cleaner(folder):
            for subdir, dirs, files in os.walk(folder):
                for file in files:
                    #Vérification si le nom de fichier esst bien dans une liste
                    if file in ('0list.txt', 'ALL_IN.txt'):

                        file_path = os.path.join(subdir, file)

                        #Suppression des données de type "90x90cm"
                        with open(file_path, 'r', encoding="utf8") as f:
                            lines = f.readlines()

                        with open(file_path, 'w', encoding="utf8") as f:
                            for line in lines:
                                new_line = re.sub(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', '', line.lower())
                                new_line = re.sub(r'(\s{2,})', ' ', new_line).strip() + '\n'

                                if new_line.strip() or line.strip(): #vérifie si les lignes sont vides ou non
                                    f.write(new_line)




#Fonction pour renommer correctement nos images pour la suite :
        def img_rename(folder):

            #Ici on demande au systeme de stocker dans une variables "files" le chemin de tout les fichiers dans le dossier choisi (sous dossiers inclus)
            files = [f for f in os.listdir(folder) if os.path.isfile(os.path.join(folder, f))] 

            #Création de la boucle de recherche dans tout les (sous)dossiers
            for subdir, dirs, files in os.walk(folder):
                for file in files:
                    
                    old = os.path.join(subdir, file) #Notre variable contenant les noms des anciens fichiers 
                    filename, extension = os.path.splitext(file) #Séparation du nom de l'extension

                    #Remplacement des caractères spéciaux par des espaces, des lettres accentuées par leur correspondance ("è" devient "e") avec unidecode
                    new_file = re.sub(r'[^a-zA-Z0-9]+', ' ', unidecode(filename)) 
                    new_file = re.sub("^\d+\s", "", new_file) # Supprime le premier nombre (si les images sont numérotées dans le nom pour éviter les erreurs futures)
                    new_file = re.sub(r'([0-9])X', r'\1x', new_file) # Transforme les X majuscules après un nombre (entre 0 et 9), en x minuscule
                    new_file = re.sub(r'(\d)\s*x\s*(\d)', r'\1x\2', new_file, flags=re.IGNORECASE) #Supprime les espaces autour des x
                    new_file = re.sub(r'(\d)\s*cm', r'\1cm', new_file, flags=re.IGNORECASE) #Supprime les espaces à gauche des cm

                    for subfolder in os.path.relpath(subdir, folder).split(os.sep):
                        if subfolder != '.':
                            subfolder_singular = subfolder[:-1] if subfolder.endswith('s') else subfolder
                            new_file = re.sub(subfolder, '', new_file, flags=re.IGNORECASE) # Supprime les mots ressemblants au nom du dossier
                            new_file = re.sub(subfolder_singular, '', new_file, flags=re.IGNORECASE) # Supprime les mots ressemblants au nom du dossier au singulier


                    #Renommage du fichier
                    new = os.path.join(subdir, new_file + extension)
                    os.rename(old, new)





#Fonction définissant les tailles des oeuvres et enregistre toute les infos dans les différentes listes
        def meta_recorder(self):

                    #Le renommage effectué on créer a nouveau des variables vides pour stocker nos futures informations
            images = [] 
            subdirs = []


    #On créer maintenant une boucle récursive parcourant à nouveau tout les dossiers tout en les stockant dans une variable
            try:
                for subdir, dirs, files in os.walk(folder):
                    subdirs.append(subdir)

            except Exception as e:
                self.ERRORS("Je n'arrive pas à rechercher dans les (sous)dossiers", e)
                return 
    
            try:
                for subdir in subdirs:
                    #On créer une liste vide qui contiendra les métadonnées de notre image ouverte
                    image_infos = []

                    for file in os.listdir(subdir):
                    #On regarde si le(s) dossier contient des images, peu importe si l'extension contient des majuscules.
                    # Il risque d'y avoir des problemes si les images ne sont pas convertie au format jpg, jpeg ou png.

                        if not any(file.lower().endswith(ext) for ext in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf']):
                             continue

# Par ailleurs voici une liste plus complete des extensions  d'images, au besoin :
# [".jpg", ".jpeg", ".png", ".gif", ".bmp", ".svg",".heic", ".ico", ".tif", ".tiff", ".psd", ".ai", ".webp", ".eps", ".raw", ".nef", ".cr2", ".crw", ".orf", ".sr2", ".srw", ".pef", ".dng", ".x3f", ".raf", ".arw", ".rw2", ".mrw", ".mef", ".nrw", ".dcr", ".kdc", ".mos", ".fff", ".3fr", ".erf", ".jp2", ".j2k", ".jpf", ".jpx", ".jpm", ".mj2", ".hdr", ".exr", ".dpx", ".cin", ".r3d", ".ari", ".mxf", ".gpr", ".cinemadng", ".cr3", ".heics", ".heif", ".avif"]):


                        #On numérote +1 les images et on leur assigne le nom du dossier comme "type"
                        image_info = {"num": len(image_infos) + 1}
                        image_info["type"] = os.path.basename(subdir) 

                        #Extraction du path de chaque images
                        picture = Image.open(os.path.join(subdir, file)) 

                        #Extraction des tailles à partir du nom de l'image (on recherche des données type 90x25x50cm)
                        sizes = re.findall(r'(\d+)x(\d+)(?:x(\d+))?(?:cm)?', file.lower())

                        #Si il y a des tailles disponnibles on les integre a des listes de dictionnaires.
                        if sizes:
                            try:
                                image_info["longueur"] = int(sizes[0][0]) # 1er [0] pointe "90x25x50cm", 2eme[0] pointe la longueur 
                                image_info["hauteur"] = int(sizes[0][1]) # par exemple [0][1] ;  dans ["90x25..."] hauteur = ["25"]
                                image_info["profondeur"] = int(sizes[0][2]) if sizes[0][2] else 1 #Pour finir, ici si on a une taille on la rajoute, sinon on met "1" par défaut.


                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec le titre d'une image", e)

                        #Sinon on calcul en fonction des tailles en pixel, que l'on converti ensuite en cm.
                        else:
                            try:
                                width, height = picture.size 

                                #on évite la limite de taille d'image imposée par python:
                                Image.MAX_IMAGE_PIXELS = None 

                                #Applique 300 dpi par défaut si on a pas les info sur la résolution, avec 2.54 pour ratio de conversion. 
                                dpi = picture.info.get("dpi", (300, 300)) 
                                width_cm = round(width / dpi[0] * 2.54) 
                                height_cm = round(height / dpi[1] * 2.54)

                                image_info["longueur"] = width_cm
                                image_info["hauteur"] = height_cm
                                image_info["profondeur"] = 1  

                                #Si on a pas de tailles, on les calculs en cm selon l'équation précédente, et on rajoute une profondeur de 1cm.
                            except Exception as e:
                                self.ERRORS("Il y a un serieux probleme avec les METADONNEES d'une image, elle semble corrompue. \n\n Je n'arrive pas à récupérer les informations de longueur x largeur pour les transformer.\n\n Essayez de tout convertir en .png ou .jpg  ", e)


                    #On termine notre liste en donnant le nom exact avec son extension
                        image_info["nom"], _ = os.path.splitext(os.path.basename(file))

                    #Puis on ajoute les nouvelles infos d'images aux anciennes                  
                        image_infos.append(image_info)


    #On finit par appeler notre fonction pour sauvegarder les éléments dans le meme dossier, en créant une nouvelle "0list.txt" si le dossier contient des images.
    # (le 0 devant permettant d'afficher la liste avant les images si elles sont triées par nom dans le dossier, pour plus de lisibilité)
                    self.save_list(image_infos, os.path.join(subdir, "0list.txt"))

                    #Chaque infos à la suite de la précédente a chaque fois qu'une image sera traitée
                    images += image_infos
    

            except Exception as e:
                self.ERRORS("Je n'arrive pas à créer de liste, \n il est possible qu'il existe un fichier inutile comme -> all_in.txt <- \n Mieux vaudrait le déplacer ou le supprimer. ", e)
                return 

    #Ceci fait, on finit par appeler notre fonction, en enregistrant tout dans un ALL_IN.txt
            self.all_for_one(folder, os.path.join(folder,"ALL_IN.txt"))





#Maintenant qu'on a établit toute nos fonctions, on a plus qu'à demander à l'utilisateur de chercher le dossier et à les lancer
        try:
            options = QFileDialog.Options()
            options |= QFileDialog.ReadOnly 
            folder = QFileDialog.getExistingDirectory(self, "Selectionnez un dossier", "",options=options) 

            #Cette partie sert à éviter les erreurs de selection de dossier 
            if folder:      
                if not self.NOPE(folder):
                    return        
            self.folder = folder

            if not folder: 
                return 
            
        except Exception as e:
            self.ERRORS("Je n'arrive pas à ouvrir le dossier \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return



        #Appel la fonction pour renommer les images
        try:

            img_rename(folder)

        except Exception as e:
            self.ERRORS("Je n'arrive pas à renommer les images \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return



        #Appel la fonction d'enregistrement des listes
        try:
            meta_recorder(self)
        except Exception as e:
            self.ERRORS("Je n'arrive pas à enregistrer les listes \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return
        


        #Appel de la fonction pour cleaner les listes        
        try:

            cleaner(self.folder)

        except Exception as e:
            self.ERRORS("Je n'arrive pas à enlever les tailles des listes \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return
        






        QMessageBox.information(self, "Information", "Le tri s'est bien effectué. \n J'ai créé la liste dans le dossier concerné")





#____ ____ _  _ ____ _  _ ____ ____ 
#|__/ |___ |\ | |__| |\/| |___ |__/ 
#|  \ |___ | \| |  | |  | |___ |  \ 

#Cette fonction vous aidera a renommer toute les images contenus dans les dossiers et sous-dossiers
#par une suite de nombre : 1 2 3 ....

    def rename(self):

        #On vide le dictionnaire folder pour éviter les erreurs
        self.folder = ""

        try:
            options = QFileDialog.Options()
            options |= QFileDialog.ReadOnly
            folder = QFileDialog.getExistingDirectory(self, "Selectionnez un dossier", options=options)

            if folder:      
                if not self.NOPE(folder):
                    return        
            self.folder = folder

            if self.folder== "":
                return
            
        except Exception as e:
            self.ERRORS("Vous n'avez pas selectionné de dossier valide", e)
            return 

        try:
            for subdir, dirs, files in os.walk(self.folder):
                #On établit notre compteur a 1 a chaque fois qu'il recherche dans un autre dossier
                counter = 1

                try :
                    for filename in files:
                        extension = os.path.splitext(filename)[1].lower()

                        try:#Si un dossier contient une image possedant une extension contenue (dans la liste suivante établie par GPT-3 (merci encore OpenAI))
                            if extension in ['.bmp', '.dib', '.dcx', '.gif', '.im', '.jpg', '.jpe', '.jpeg', '.pcd', '.pcx', '.png', '.pbm', '.pgm', '.ppm', '.psd', '.tif', '.tiff', '.xbm', '.xpm', '.pdf'] :
                                try:
                                    new_name = str(counter) + extension
                                    #On rajoute +1 au compteur qui sera également son nom
                                    counter += 1

                                    old = os.path.join(subdir, filename)

                                except Exception as e:
                                    self.ERRORS("J'ai perdu le chemin d'une image", e)
                                    return     
                                                            
                                try:
                                    new = os.path.join(subdir, new_name)

                                    os.rename(old, new)

                                except Exception as e:
                                    self.ERRORS("Je n'arrive pas à renommer une image", e)
                                    return 
                        
                        except Exception as e:
                            self.ERRORS("Une extension pose problème", e)
                            return 
                        
                except Exception as e:
                    self.ERRORS("un fichier pose problème", e)
                    return 
        
  
        except Exception as e:
            self.ERRORS("Un dossier pose problème", e)
            return 
        





        QMessageBox.information(self, "Information", "toute les images ont été renommées")







#____ ____ ____ ___    _    _ ____ ___ 
#[__  |  | |__/  |     |    | [__   |  
#___] |__| |  \  |     |___ | ___]  |  


#Fonction pour demander la cote akoun
    def demander_cote_akoun(self):

        #Créer la pop-up pour demander la cote AKOUN
        pop_up = QMessageBox()
        pop_up.setWindowTitle("Entrez votre cote AKOUN")

        #Label pour le texte
        label = QLabel("Entrez votre cote AKOUN (maximum 7 chiffres) :")
        label.setAlignment(Qt.AlignCenter)

        #Demande d'entrer la cote AKOUN
        champ_texte = QLineEdit()
        champ_texte.setMaxLength(7)

        #Répartition des éléments à la pop-up
        layout = pop_up.layout()
        layout.addWidget(label, 0, 0)
        layout.addWidget(champ_texte, 1, 0)
        pop_up.setLayout(layout)

        btn_launch = pop_up.exec_()

        #Si le bouton OK a été cliqué, enregistrer la cote AKOUN
        if btn_launch == QMessageBox.RejectRole or champ_texte.text() == "":
            return 
        
        #Sinon ciao
        else:
            return int(champ_texte.text())



#La fonction permettant le tri :
    def validation(self):

#On commence par rechercher notre liste
        options = QFileDialog.Options()
        options |= QFileDialog.ReadOnly 
        fileName, _ = QFileDialog.getOpenFileName(self, "Ouvrir votre liste", "", "Text Files (*.txt);;All Files (*)", options=options)

        if fileName: 
            self.fileName = fileName
            with open(fileName, "r", encoding="utf8") as file:
                data = file.read()
        cote_akoun = self.demander_cote_akoun() #On commence par créer une variable pour la cote AKOUN

        # Affecter la valeur de la cote AKOUN à la variable self.akoun
        if cote_akoun is not None:
            self.akoun = cote_akoun

            try:
                if hasattr(self, 'fileName'): #Si un fichier texte a bien été ouvert, on récupères les données à l'interieur
                    with open(self.fileName, "r") as f:
                        lines = f.readlines()
                    data = {}

#On va maintenant récupérer les mots pour chaque lignes et les assigner à des variables 
                    try:
                        for line in lines:
                            elements = line.split() #On transforme les lignes en "phrases"
                            num = elements[0] #Le premier "mot" de la liste sera attribué au numéro de la ligne
                            data[num] = {}
                            
                            try:
                                data[num]["type"] = elements[1] #le 2eme "mot" sera le type et ainsi de suite

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec le nom du dossier : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["longueur"] = int(elements[2])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la longueur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["hauteur"] = int(elements[3])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la hauteur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["profondeur"] = int(elements[4])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la profondeur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["nom"] = " ".join(elements[5:])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec le nom d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            #Si la profondeur est de 0, pour éviter les erreurs de calculs, on remplace la valeur par 1.
                            if elements[4] in ["0"]: 
                                data[num]["profondeur"] = 1


#Calcul de la valeur de l'oeuvre : (longuer x hauteur x profondeur x la cote AKOUN)/3250
                            data[num]["prix"] = round((data[num]["longueur"] * data[num]["hauteur"] * data[num]["profondeur"] * self.akoun) / 3250)

                            folder_path = os.path.dirname(os.path.abspath(self.fileName)) # Récupère le chemin du dossier où le fichier a été ouvert
                            directory = os.path.join(folder_path, data[num]["type"]) # Crée le chemin complet pour le nouveau dossier
                            os.makedirs(directory, exist_ok=True) # Crée le nouveau dossier à l'emplacement spécifié


#Pour finir on tri nos fichiers et on les envois la ou ils doivent etre   
                            try:
                                if elements[4] in ["0","1"]:  #Pour les fichiers n'ayant pas de profondeur, on n'affichera pas cette dernière dans les liste.

                                    try :
                                        with open(f"{directory}/{data[num]['type']}.txt","a", encoding="utf8") as f: #On ouvre chaque "phrases"
                                            f.write(f"{num} {data[num]['type']} {data[num]['nom']} {data[num]['longueur']}cm x {data[num]['hauteur']}cm  {data[num]['prix']} €  \n") #On place les éléments dans l'ordre et on écrit

                                    except Exception as e:
                                        self.ERRORS("Il y a un probleme dans l'enregistrement de la liste contenant des oeuvres sans profondeur", e)
                                        return 
                                    
                                else :
                                    try :    
                                        with open(f"{directory}/{data[num]['type']}.txt", "a", encoding="utf8") as f:
                                            f.write(f"{num} {data[num]['type']} {data[num]['nom']} {data[num]['longueur']}cm x {data[num]['hauteur']}cm x {data[num]['profondeur']}cm {data[num]['prix']} € \n")

                                    except Exception as e:
                                        self.ERRORS("Il y a un probleme dans l'enregistrement de la liste contenant des oeuvres avec profondeur", e)
                                        return 
                                    
                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la liste choisie", e)
                                return 

                    except Exception as e:
                        self.ERRORS("Il y a eu un probleme avec la récupération des noms dans la liste : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                        return 

            except Exception as e:
                self.ERRORS("FELICITATION !!! \n\n Vous m'avez cassé. \n\n L'erreur rencontrée m'est totalement inconnue", e)
                return 





            #On terminera en affichant un pop up expliquant que le script a bien fonctionné.
            QMessageBox.information(self, "Information", "Je suis entrain de trier correctement tout ca.")
            self.akoun = None #Comme ca la cote est réinitialiser pour la prochaine fois qu'on appel la fonction.





#____ ____ ____ ___  _  _ _ ____ ____ _       _  _ ____ ____ ____    _ _  _ ___ ____ ____ ____ ____ ____ ____ 
#| __ |__/ |__| |__] |__| | |    |__| |       |  | [__  |___ |__/    | |\ |  |  |___ |__/ |___ |__| |    |___ 
#|__] |  \ |  | |    |  | | |___ |  | |___    |__| ___] |___ |  \    | | \|  |  |___ |  \ |    |  | |___ |___ 


#On passe mainteant à la création de la fenetre utilisateur :

    def GUI(self):
        
        #Ici on définit les parametres principaux de notre fenetre
        self.setMinimumSize(200,500)
        self.setWindowTitle("TRI") 
        self.setWindowIcon(QIcon("ico\trieur.png")) #Notre logo à l'emplacement relatif au dossier d'execution


        #Contenu principal, du premier jusqu'au dernier bouton en commençant par celui qui créer notre liste
        self.list_maker = QPushButton("Créer une liste", self, objectName="list_maker")
        self.list_maker.clicked.connect(self.list_making)


        #Un boutton pour permettre de renommer les images de tout les dossiers et sous dossiers d'un dossier selectionné
        self.renamer = QPushButton("Renommer images", self, objectName="renamer")
        self.renamer.clicked.connect(self.rename)


        #Bouton "valider" qui lance notre script une fois tout les parametres établis
        self.launch = QPushButton("Créer liste avec cote AKOUN", self, objectName="launch")
        self.launch.clicked.connect(self.validation) #La commande de lancement

        #On créer cette variable pour que le zoom n'affecte que notre page html
        self.webview = QWebEngineView()

        #Affichage d'une page html pour le tuto 
        self.tuto = QTextBrowser()
        self.tuto.setMinimumSize(180, 180)

        with open(ressource_path('html/tuto.html'), 'r', encoding='utf-8') as f_htm: #on lit la page et on l'affiche
            html = f_htm.read()
            self.tuto.setHtml(html)
     
        #Filtre d'événement pour transmettre les événements de la souris à la fenêtre principale et éviter les erreurs
        self.tuto.viewport().installEventFilter(self)

    
        #On finit par placer nos éléments
        layout = QVBoxLayout()

        layout.addSpacing(10)
        layout.addWidget(self.list_maker)
        layout.addSpacing(10)
        layout.addWidget(self.renamer)
        layout.addSpacing(10)
        layout.addWidget(self.launch)
        layout.addSpacing(50)
        layout.addWidget(self.tuto)
        

        #On centralise les widgets, les éléments que l'on a créé dans notre grille
        widget = QWidget(self)
        widget.setLayout(layout)
        self.setCentralWidget(widget)


        #On finit par afficher la fenetre
        self.show()





#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |

#ENDING | https://www.youtube.com/watch?v=CgZVrvQZB6U&ab_channel=SECRETGUEST :3

if __name__ == "__main__":

    logger = logging.getLogger(__name__)
    logger.setLevel(logging.DEBUG)
    handler = logging.FileHandler('error.log')
    handler.setLevel(logging.ERROR)
    formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s')
    handler.setFormatter(formatter)
    logger.addHandler(handler)

    app = QApplication(sys.argv)
    window = trieur()
    sys.exit(app.exec_())
