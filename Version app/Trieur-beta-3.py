#          ████████     ██████
#         █░░░░░░░░██_██░░░░░░█
#        █░░░░░░░░░░░█░░░░░░░░░█
#       █░░░░░░░███░░░█░░░░░░░░░█
#       █░░░░███░░░███░█░░░████░█
#     █░░░██░░░░░░░░███░██░░░░██
#    █░░░░░░░░░░░░░░░░░█░░░░░░░░███
#    █░░░░░░░░░░░░░██████░░░░░████░░█
#    █░░░░░░░░░█████░░░████░░██░░██░░█
#   ██░░░░░░░███░░░░░░░░░░█░░░░░░░░███
#  █░░░░░░░░░░░░░░█████████░░█████████
# █░░░░░░░░░░█████ ████   ████ █████ █
# █░░░░░░░░░░█      █ ███   █   ███ █ █
#█░░░░░░░░░░░░█   ████ ████    ██ ████
#░░░░░░░░░░░░░█████████░░░████████░░░█
#░░░░░░░░░░░░░░░░█░░░░░█░░░░░░░░░░░░█
#░░░░░░░░░░░░░░░░░░░░██░░░░█░░░░░░██
#░░░░░░░░░░░░░░░░░░██░░░░░░░███████
#░░░░░░░░░░░░░░░░██░░░░░░░░░░█░░░░░█                                            _____                                 _____                                            _____                                                   _____
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                          /\    \                               /\    \                                          /\    \                                                 /\    \
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                      ::                 /::\    \                             /::\    \                                        /::\____\                                               /::\____\
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█                                        /::::\    \                           /::::\    \           :::         ::           ::: ::/    /                         :                   :: ::/    /
#░░░░░░░░░░░█████████░░░░░░░░░░░░░░██                                       /::::::\    \                         /::::::\    \                               ::: : :::/    /                                              /:::/    /
#░░░░░░░░░░█▒▒▒▒▒▒▒▒███████████████▒▒█                                     /:::/\:::\    \                    :: ::::/\:::\    \                                  /:::/    /                                              /:::/    /
#░░░░░░░░░█▒▒███████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                    /:::/__\:::\    \                     /:::/__\:::\    \                                /:::/    /                                            :::: :/____/
#░░░░░░░░░█▒▒▒█▓▓▓▓██████████████████                                    /::::\   \:::\    \                   /::::\   \:::\    \                              /:::/    /                                              /::::\    \
#░░░░░░░░░██▒▒█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                       /::::::\   \:::\    \                 /::::::\   \:::\    \                            /:       /      _____                                   /::::::\    \   _____
#░░░░░░░░░░█▒▒█▓█████████████████ ████                                 /:::/\:::\   \:::\ ___\               /:::/\:::\   \:::\____\                          /:::/____/      /\    \                                 /:::/\:::\    \ /\    \
#░░░░░░░░░░█▒▒██▓▓▒▓▒▓▒▓▒▒▒▒▒▒▒▒▓█▓▒▒▒█                               /:::/__\:::\   \:::|    |             /:::/  \:::\   \:::|    |                         :::|    /      /::\____\                        ::::::: :::/ : :::\    /::\____\
#░░░░░░░░░█▒▒████████▓▒███▓██▒▒▒▒▒▒▒▒▒█                  :            \:::\   \:::\  /:::|____|             \::/   |::::\  /:::|____|                      : :: :|____\     /:::/    /                               \::/    \:::\: ::::/    /
#░░░░░░░░░█▒▒▒▒▒▒▒▒▒█████████████▓█▓██                                 \:::\   \:::\/:::/    /               \/____|:::::\/:::/    /                          \:::\    \   /:::/    /                                 \/____/: :::\/:::/    /
#░░░░░░░░░░████████▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒█                                  \:::\   \::::::/    /                      |:::::::::/    /                            \:::\   :: : ::/    /                                 :  :  : : :::::::/    /
#░░░░░░░░░░░░░░░░░░██████████████████                                    \:::\   \::::/    /          :  :         |::|\::::/    /           ::                 \:::\    /:::/    /               ::::                          \::       /
#░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░█            ::                           \:::\  /:::/    /                      :: ::| \::/____/                                \:::\__/:::/    /                                              /:::/    /
#██░░░░░░░░░░░░░░░░░░░░░░░░░░░██                                           \:::\/:::/    /                         |::|  ~|                                       \::::::::/    /                                             : :::/    /
#▓██░░░░░░░░░░░░░░░░░░░░░░░░██                                              \::::::/    /                          |::|   |                                        \::::::/    /                                              /:::/    /
#▓▓▓███░░░░░░░░░░░░░░░░░░░░█                                                 \::::/    /                           \::|   |                                         \::::/    /                              ::: :           /:::/    /
#▓▓▓▓▓▓███░░░░░░░░░░░░░░░██                                 :                 \::/____/            :                \:|   |               :    ::::                  \::/____/                                               \::/    /
#▓▓▓▓▓▓▓▓▓███████████████▓▓█                                                   ⠋                                     \|___|                                           ⠩                                                      \/____/
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓██
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                                                                                                                                                                                               |                                                                    |                                      |
#▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█                                                                    |                                                                                                             |
#______________________________                                                                                                                       |                                                                                                                      |                                                                                                                                              |                    |
#___________________________
#_ ______ _____ _________
# /            /                                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |

#        \                          |                                |                                               |  |                                          |                    |                                          |                       |                    |  |                                           |                    |        |                    |                              |


#      |               |                                 |

#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  |                                     |

#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    |
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                                                        |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                       |                    |

#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                |                                        |

#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |     |                                |                       |                              |                                |
#           |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |

#   |         |                                   PRESENTATION                                                |                                |                    |   |                                |                    |   |                                |                    |        |                                |                    |
#                                                                                                                               |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#                |                            |                 |                          |                                                                              |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |

#        |                         Ce trieur permet de calculer le prix plus

#                              rapidement pour des artistes cotés AKOU tels que                      |                                           |               |                                           |               |                                           |                    |                                           |

#                 Nathacha , artiste peintre de l'abstraction https://www.artnathacha.com/                |                                |                                          |      |                                |                                          |      |                                |                                          |           |                                |
#                                                                                                    |                                                                 |                      |                     |                       |                      |                     |                       |                      |                     |                            |

#      |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |

#                   |            |                   Anyway          |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |

#              |                      |                 have                                                 |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                     |                                           |


#                 |                                  FUN         |                        |                                         |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                                                      |

#                                                         =)

#
#                                |                      or                                       |                                                            |                    |                |                       |                    |                |                       |                    |                    |                                           |


#              |                              |       DIE ! !         |                       |                            |                |                       |                    |                |                       |                    |                    |                                           |#      |                        |                                         |                                |

#
#                                                     !                                       |                                |                    |  |                                |                    |  |                                |                    |       |                                |                    |

#      |               |                                 !

#                  |                                                |            |                                   |                               |                           |                               |                           |                               |                                |                               |
#           |                                  !                                     |

#                  |                     |                                                     |                                   |                               |     |                                   |                               |     |                                   |                               |          |                                   |                               |
#   |                          |                       |                    |
#           |                                    |                                         |     |                    |                                    | |     |                    |                                    | |     |                    |                                    |      |     |                    |                                    |
#      |                        |                                 |      |                                |                       |                    |                |                       |                    |                |                       |                    |                    |                                           |

#                      |                                                |      |                                   |                               |                         |                               |                         |                               |                              |                               |
#           |                                   |                               |                   |                                |                       |                    |          |                                |                       |                    |          |                                |                       |                    |               |                                                                |

#                  |                     |
#   |                                |                       |                    |            |                                |                       |                    |     |                                |                       |                    |                                    |                       |                              |                                                                        |
#           |                               |                                         |                              |                       |                    |                           |                       |                    |                           |                       |                    |                                |                       |                    |

#_ _  _ ____ ___ ____ _    _    ____ ___ _ ____ _  _
#| |\ | [__   |  |__| |    |    |__|  |  | |  | |\ |
#| | \| ___]  |  |  | |___ |___ |  |  |  | |__| | \|


import os,re,sys,threading,logging

from PIL import Image
from unidecode import unidecode

from PyQt5.QtWidgets import QApplication, QMainWindow, QPushButton, QFileDialog, QLabel, QLineEdit, QScrollArea, QCheckBox, QVBoxLayout, QWidget, QMessageBox, QTextBrowser, QHBoxLayout
from PyQt5.QtGui import QIntValidator, QIcon
from PyQt5.QtCore import Qt


#___  ____ _ _ _ ____ ____    ___  _    ____ _  _ ___
#|__] |  | | | | |___ |__/    |__] |    |__| |\ |  |
#|    |__| |_|_| |___ |  \    |    |___ |  | | \|  |


#OPENING | https://www.youtube.com/watch?v=_85LaeTCtV8 :3

#Fonction pour créer un executable

def ressource_path(relative_path):
    try:
        base_path=sys._MEIPASS

    except Exception:
        base_path = os.path.abspath('.')

    return os.path.join(base_path ,relative_path)

# Pour que la création d'un fichier executable s'effectue, il faut inclure tout les chemins relatif dans ressource_path()
# Exemple : 
# /icon/lol.png  DEVIENT  ressource_path(/icon/lol.png)
# idem dés que l'on ouvre un fichier relatif en lecture, ou en écriture.



#___  ____ ____ ____ ____ ____ _  _
#|__] |__/ |  | | __ |__/ |__| |\/|
#|    |  \ |__| |__] |  \ |  | |  |


#Création d'une classe contenant nos fonctions et boutons principaux
class trieur(QMainWindow):
    def __init__(self):
        super().__init__()
        self.GUI()
        

#On passe mainteant à la création de la fenetre utilisateur :

    def GUI(self):

        self.setFixedSize(200,500) #La taille largeur, hauteur
        self.setWindowTitle("TRI") 
        self.setWindowIcon(QIcon(ressource_path(r"ico\trieur.png"))) #Notre logo à l'emplacement relatif au dossier d'execution
        self.setStyleSheet("background-color: #1c1c1c; color: white;")



#Contenu principal, du premier jusqu'au dernier bouton en commençant par celui qui créer notre liste
        self.list_maker = QPushButton("Créer une liste", self) # Voila un tuto pour la compréhension de la notion "self" : https://www.edureka.co/blog/self-in-python/#what )
        f_list_maker = self.list_maker.font() #On parametre une typo
        f_list_maker.setPointSize(16) #On lui assigne une taille
        self.list_maker.setFont(f_list_maker) #On assigne la typo à l'objet la contenant
        self.list_maker.setStyleSheet("background-color: yellow; color: black;") #On assigne une couleur de fond à notre widget, une couleur de police.
        self.list_maker.clicked.connect(self.list_making)


#On créer une checkbox pour savoir si la liste se fait à propos d'oeuvres numériques ou non
        self.digital_checkbox = QCheckBox("Oeuvres numérique", self)
        f_digital_checkbox = self.digital_checkbox.font()
        f_digital_checkbox.setPointSize(12)
        self.digital_checkbox.setFont(f_digital_checkbox)
        self.digital_checkbox.setStyleSheet("color: white;") 
        self.digital_checkbox.stateChanged.connect(self.digital_checker)
        self.digital_checkbox.setChecked(True)

#Boutton pour rechercher notre liste :
        self.list = QPushButton("Chercher la liste", self)
        f_list = self.list.font() 
        f_list.setPointSize(16) 
        self.list.setFont(f_list) 
        self.list.setStyleSheet("background-color: yellow; color: black;") 
        self.list.clicked.connect(self.openFile) #On lui assigne sa commande de dedamnder à l'utilisateur de chercher la liste.

#Affichage du titre "Cote Akoun"
        self.cote = QLabel(self)
        self.cote.setText("ENTRER COTE AKOUN :")
        f_cote = self.cote.font()
        f_cote.setPointSize(11)
        self.cote.setFont(f_cote)
        self.cote.setStyleSheet("color: white;") 

        
#Objet ou l'utilisateur peut écrire sa cote        
        self.cote_akoun = QLineEdit(self)
        f_cote_akoun = self.cote_akoun.font()
        f_cote_akoun.setPointSize(18)
        self.cote_akoun.setFont(f_cote_akoun)
        self.cote_akoun.setStyleSheet("color: white;")  
        self.cote_akoun.setValidator(QIntValidator()) #Oblige à ne rentrer que nes nombres


#Bouton "valider" qui lance notre script une fois tout les parametres établis
        self.launch = QPushButton(" GO ", self)
        f_launch = self.launch.font()
        f_launch.setPointSize(18)
        self.launch.setFont(f_launch)
        self.launch.setStyleSheet("background-color: yellow; color: black;")

        self.launch.clicked.connect(self.validation) #La commande de lancement

#On définit une barre de défilement pour le tuto apparaissant juste apres 
        self.scroller = QScrollArea(self)
        self.scroller.setWidgetResizable(True)
        self.scroller.setFixedSize(180, 180)
        self.scroller.move(10, 300)

#Maintenant on  définit notre tutoriel en fonction de notre barre de défilement via du HTML
        self.tuto = QTextBrowser(self.scroller) #On utilise QTextBrowser pour pouvoir cliquer sur les liens dans le texte
        self.tuto.setOpenExternalLinks(True) #On active le clic sur les liens.

        #Oui je sais c'est extremement schlag mais j'ai pas de meilleure méthode pour que ca soit lisible dans le code ^^'
        self.tuto.setText(
                                                                                                                                "<br>"
            "<center>TUTORIEL :</center> "
                                                                                                                                "<br><br>"
            "Si ce tutoriel n'est pas assez ergonomique, "
                                                                                                                                "<br>"
            "vous pouvez toujours copier le texte en utilisant les touches ctrl+A"
                                                                                                                                "<br>"
            "puis coller le texte dans un autre document, un bloc note par exemple."
                                                                                                                                "<br><br>"
            "Vous pouvez également lire le README.md disponible ici : "
                                                                                                                                "<br><br>"
            "- <a href='https://github.com/SECRET-GUEST/trieur' style='color: #F2F2F2;'><b>GITHUB</b></a> ." 
                                                                                                                                "<br><br>"
            "Notez que les dossiers / listes seront créées à l'emplacement ou vous lancerez le programme."  
                                                                                                                                "<br><br>" 
            "Si les dossiers ou des listes au meme nom que le type d'oeuvre existent déja,"
                                                                                                                                "<br>" 
            "les données viendront simplement s'y ajouter"                                                                                                                               
                                                                                                                                "<br><br><br>"
            "<center>Utilisation :</center> "
                                                                                                                                "<br><br>"
            "Tout d'abord, il faut noter que la création de liste va renommer toute les images du dossier selectionné, "
                                                                                                                                "<br>"
            "remplacant TOUT les caractères spéciaux par des caractères normaux ou des espaces."
                                                                                                                                "<br><br>"
            "Utilisez le bouton création de liste pour avoir une liste conforme, "
                                                                                                                                "<br>"
            "mais vérifiez la quand meme, il vaut mieux la retravailler au besoin. "
                                                                                                                                "<br><br>"
            "Le bouton oeuvres numérique sert à determiner les propriétés physique."
                                                                                                                                "<br><br>"
            "Utilisez le bouton cherche liste pour rechercher votre liste à trier au format.txt "
                                                                                                                                "<br><br>"
            "Le format de votre liste doit ressembler à ca :  "
                                                                                                                                "<br><br>"
            "1 3D 300 200 0 le petit charles   "                                  
                                                                                                                                "<br>"
            "2 numerique 200 50 1 jean-luc "
                                                                                                                                "<br>"
            ". . . " 
                                                                                                                                "<br><br>"
            "soit avec un esapace entre chaques valeurs, <b> sans caractères spéciaux (é, /, ...)</b>: "
                                                                                                                                "<br><br><br>"
            "1.Le numero"
                                                                                                                                "<br><br>"
            "2.Le type d'oeuvre <b>EN UN SEUL MOT</b>"
                                                                                                                                "<br><br>"  
            "3.La longueur"
                                                                                                                                "<br><br>"
            "4.La largeur"
                                                                                                                                "<br><br>"
            "5.La profondeur, <b>mettez 1 ou 0 pour une oeuvre papier ou numérique</b>"
                                                                                                                                "<br><br>"
            "6.Le titre de l'oeuvre"
                                                                                                                                "<br><br><br>"
            "Maintenant, inscrivez votre cote AKOUN. "
                                                                                                                                "<br><br><br>"
            "Enfin, Appuyez sur le bouton valider pour lancer un tri automatique des données"
            )

        f_tuto = self.tuto.font()
        f_tuto.setPointSize(12)
        self.tuto.setFont(f_tuto)
        self.tuto.setStyleSheet("background-color : #404040; color : white; border: 1px solid black;") 
        self.tuto.setReadOnly(True) #On empeche l'écriture dans la fenetre de tutoriel
        self.scroller.setWidget(self.tuto) #On assigne la scrollbar au message

#On place nos éléments dans une colone verticale, un layout
        layout = QVBoxLayout()

        layout.addSpacing(10) # On espace les éléments dans la grille
        layout.addWidget(self.list_maker) #On les place
        layout.addWidget(self.digital_checkbox)
        layout.addSpacing(20)
        layout.addWidget(self.list)
        layout.addSpacing(20)
        layout.addWidget(self.cote)
        layout.addWidget(self.cote_akoun)
        layout.addSpacing(20)
        layout.addWidget(self.launch)
        layout.addSpacing(10)
        layout.addWidget(self.scroller)
        

#On centralise les widgets, les éléments que l'on a créé dans notre grille
        widget = QWidget(self)
        widget.setLayout(layout)
        self.setCentralWidget(widget)

#On finit par afficher la fenetre
        self.show()





#################################################################################
# Toujours dans notre fenetre, on va maintenant definir les fonctions appelées  #
#################################################################################  

#___  _  _ ____ ____ 
#|__] |  | | __ [__  
#|__] |__| |__] ___] 
                    
    #La première concernera les erreurs dans l'application

    def ERRORS(self, message, exception=None):

        alert = QMessageBox()
        alert.setWindowTitle("GAME OVER")
        alert.setText(message)
        alert.setIcon(QMessageBox.Warning)
        error_show = alert.addButton("Ca coince ici !", QMessageBox.ActionRole)
        alert.exec_()

        if alert.clickedButton() == error_show and exception is not None:
            logger.error(str(exception), exc_info=True)
            os.startfile(ressource_path('error.log'))


#_    _ ____ ___    _  _ ____ _  _ _ _  _ ____ 
#|    | [__   |     |\/| |__| |_/  | |\ | | __ 
#|___ | ___]  |     |  | |  | | \_ | | \| |__]    
# 



                                          
#On crée une fonction pour vérifier l'état (cochée ou non) de la checkbox
    def digital_checker(self, state):
        try:
            self.digital = state == Qt.Checked

        except Exception as e:
            #Une erreur sauvage est apparue
            self.ERRORS("Essayez de cocher / décocher la case numérique", e)
            return #On met fin à la fonction qui s'est emballé.

#Création de la liste à partir des données
    def list_making(self):


#On demande dans un premier temps de rechercher le dossier concerné par l'élaboration de notre liste :
        try :
            options = QFileDialog.Options()
            options |= QFileDialog.ReadOnly 
            folder = QFileDialog.getExistingDirectory(self, "Open Folder", "",options=options) 


            #Cette partie sert à éviter les erreurs de selection de dossier 
            if folder:
                self.folder = folder

            if not folder: 
                return 
            
        except Exception as e:
            self.ERRORS("Vous n'avez pas selectionner un dossier valide", e)
            return 


        #Maintenant on va renommer correctement nos images pour la suite
        #Ici on demande au systeme de stocker dans une variables "files" le chemin de tout les fichiers dans le dossier choisi (sous dossiers inclus)
        files = [f for f in os.listdir(folder) if os.path.isfile(os.path.join(folder, f))] 
        
        #Création d'une variable vide de chargement
        waiting = []

        #Création de la boucle de recherche dans tout les (sous)dossiers
        try:
            for subdir, dirs, files in os.walk(folder):
                for file in files:
                    old = os.path.join(subdir, file) #Notre variable contenant les noms des anciens fichiers 
                    filename, extension = os.path.splitext(file) #Séparation du nom de l'extension

                    #Puis on remplace les lettres accentué avec unidecode, par des lettres standard, ainsi que TOUT les caractères spéciaux par des espaces 
                    new_filename = re.sub(r'[^a-zA-Z0-9]+', ' ', unidecode(filename)) 

                    #Remplacement de l'ancien nom par le nouveau pour tout les (sous)dossiers, suivi de l'extension.
                    new = os.path.join(subdir, new_filename + extension)
                    os.rename(old, new)

                    #Chargement du script 
                    wait = threading.Thread(target=os.rename, args=(old, new))
                    wait.start()
                    waiting.append(wait) 
        
            #Attends que le script ait finis de s'exécuter
            for wait in waiting:
                wait.join()

        except Exception as e:
            self.ERRORS("Je n'arrive pas à renommer les images \n pas la peine de m'insulter ! \n Moi non plus je ne sais pas pourquoi.", e)
            return
        
        #Le renommage effectué on créer a nouveau des variables vides pour stocker nos futures informations
        images = [] 
        subdirs = []


#On créer maintenant une boucle récursive parcourant à nouveau tout les dossiers tout en les stockant dans une variable
        try:
            for subdir, dirs, files in os.walk(folder):
                subdirs.append(subdir)

        except Exception as e:
            self.ERRORS("Je n'arrive pas à rechercher dans les (sous)dossiers", e)
            return 
 
        
        try:
            for subdir in subdirs:
                #On créer une liste vide qui contiendra les métadonnées de notre image ouverte
                image_infos = []

                for file in os.listdir(subdir):
                #On regarde si le(s) dossier contient des images, peu importe si l'extension contient des majuscules.
                    if not file.lower().endswith(".jpg") and not file.lower().endswith(".jpeg") and not file.lower().endswith(".png"):
                        continue
                    #On numérote +1 les images et on leur assigne le nom du dossier comme "type"
                    image_info = {"num": len(image_infos) + 1}
                    image_info["type"] = os.path.basename(subdir) 

                #Convertis les pixels en cm pour notre liste si elle s'est établie avec des oeuvres numérique :
                    try :
                        if self.digital:
                            picture = Image.open(os.path.join(subdir, file)) 
                            width, height = picture.size 

#On a maintenant 2 manières de procéder: 
#----------------> La première en utilisant un ratio fixe, 1cm = 37.79527559055 pixels :

#                           ratio = 37.79527559055 
#                           width_cm = round(width / ratio)
#                           height_cm = round(height / ratio)

#----------------> La seconde en utilisant la résolution de l'image :

                            Image.MAX_IMAGE_PIXELS = None #on évite la limite de taille d'image imposée par python

                            dpi = picture.info.get("dpi", (300, 300)) #Applique 300 dpi par défaut si on a pas les info sur la résolution
                            width_cm = round(width / dpi[0] * 2.54) #2.54 est le ratio standart
                            height_cm = round(height / dpi[1] * 2.54)

                            image_info["longueur"] = width_cm
                            image_info["largeur"] = height_cm


                    except Exception as e:
                        self.ERRORS("Il y a un probleme concernant la résolution des images, ou leur taille \n\n je vais tenter d'appliquer un ratio standard (1cm = 37.79527559055 pixels) \n\n Ce ne sera pas super précis, il vaudrait mieux modifier les images et recommencer", e)
                        try : #Si le calcul via les DPI ne fonctionne pas, on essaie la methode "ratio fixe"
                            if self.digital: 
                                picture = Image.open(os.path.join(subdir, file)) 
                                width, height = picture.size 
                                ratio = 37.79527559055 
                                width_cm = round(width / ratio)
                                height_cm = round(height / ratio)

                                image_info["longueur"] = width_cm
                                image_info["largeur"] = height_cm

                        except Exception as e:
                            self.ERRORS("Il y a un serieux probleme avec les metadonnées des images, \n\n Je n'arrive pas à récupérer les informations de longueur x largeur pour les transformer", e)
                            return 
                        
                #On donne une "profondeur" par défaut de 0(cm) a notre image numérique       
                    image_info["profondeur"] = 1  

                #On termine notre liste en donnant le nom exact avec son extension dans le fichier
                    image_info["nom"], _ = os.path.splitext(os.path.basename(file))

                    image_infos.append(image_info)


#On finit par appeler notre fonction pour sauvegarder les éléments dans le meme dossier dans une 0list.txt 
# (le 0 devant permettant d'afficher la liste avant les images si elles sont triées par nom dans le dossier, pour plus de lisibilité)
                self.save_list(image_infos, os.path.join(subdir, "0list.txt"))

                #Chaque infos à la suite de la précédente a chaque fois qu'une image sera traitée
                images += image_infos


        except Exception as e:
            self.ERRORS("Je n'arrive pas à créer de liste, \n il est possible qu'un fichier pose problème \n voir que le dossier entier soit corrompu.", e)
            return 

#Ceci fait, on finit par appeler notre fonction, en enregistrant tout dans un ALL_IN.txt
        self.all_for_one(folder, os.path.join(folder,"ALL_IN.txt"))
        QMessageBox.information(self, "Information", "Le tri s'est bien effectué. \n J'ai créé la liste dans le dossier concerné")


# On va maintenant définir la fonction d'enregistrement de la 0list.txt :
    def save_list(self, image_infos, filepath):
        with open(ressource_path(filepath), "w") as file:
            for image_info in image_infos:
                    line = "{num} {type}".format(**image_info) #On commence par enregistrer le numéro de l'image, son type

                    if self.digital: # Si les oeuvres concernées sont numérique, on ajoute automatiquement la longueur, largeur et profondeur en cm
                        line += " {longueur} {largeur} {profondeur}".format(**image_info)

                    line += " {nom}\n".format(**image_info) # On rajoute le nom complet de l'image.png
                    
                    file.write(line) # On recommence à la ligne pour chaque nouvelle image

#Pour finir on définira également la fonction d'enregistrement de la All_IN.txt qui regroupe toute les listes.
    def all_for_one(self, folder, filepath):
        allin = []

#Bon pour le reste, il suffit de lire, la fonction recupère tout les fichiers .txt de tout les (sous)dossiers, et bref ... 
        for subdir, dirs, files in os.walk(folder):
            for file in files:
                if file.endswith('.txt') :
                    with open(os.path.join(subdir, file), 'r') as all: #'r' signifie que la liste est en lecture seule
                        for line in all:
                            allin.append(line)

        with open(filepath, 'a') as f: #On ajoute le reste des infos, par lignes, sans écraser les données précédentes
            for line in allin:
                f.write(line)


#____ ____ ____ ___    _    _ ____ ___ 
#[__  |  | |__/  |     |    | [__   |  
#___] |__| |  \  |     |___ | ___]  |  
                                      
                   

#Maintenant on défini notre fonction permettant d'ouvrir notre liste.txt
    def openFile(self):
        options = QFileDialog.Options()
        options |= QFileDialog.ReadOnly 
        fileName, _ = QFileDialog.getOpenFileName(self, "Ouvrir votre liste", "", "Text Files (*.txt);;All Files (*)", options=options)

        if fileName: 
            self.fileName = fileName
            with open(ressource_path(fileName), "r") as file:
                data = file.read()

#La fonction permettant le tri :
    def validation(self):
            self.akoun  = int(self.cote_akoun.text()) #On commence par créer une variable pour la cote AKOUN
        
            try:
                if hasattr(self, 'fileName'): #Si un fichier texte a bien été ouvert, on récupères les données à l'interieur
                    with open(ressource_path(self.fileName), "r") as f:
                        lines = f.readlines()
                    data = {}

#On va maintenant récupérer les mots pour chaque lignes et les assigner à des variables 
                    try:
                        for line in lines:
                            elements = line.split() #On transforme les lignes en "phrases"
                            num = elements[0] #Le premier "mot" de la liste sera attribué au numéro de la ligne
                            data[num] = {}
                            
                            try:
                                data[num]["type"] = elements[1] #le 2eme "mot" sera le type et ainsi de suite

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec le nom du dossier : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["longueur"] = int(elements[2])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la longueur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["largeur"] = int(elements[3])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la largeur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["profondeur"] = int(elements[4])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la profondeur d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            try:
                                data[num]["nom"] = " ".join(elements[5:])

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec le nom d'une image : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                                return 
                            
                            #Si la profondeur est de 0, pour éviter les erreurs de calculs, on remplace la valeur par 1.
                            if elements[4] in ["0"]: 
                                data[num]["profondeur"] = 1


#Calcul de la valeur de l'oeuvre : (longuer x largeur x profondeur x la cote AKOUN)/3250
                            data[num]["prix"] = round((data[num]["longueur"] * data[num]["largeur"] * data[num]["profondeur"] * self.akoun) / 3250)

                            folder_path = os.path.dirname(os.path.abspath(self.fileName)) # Récupère le chemin du dossier où le fichier a été ouvert
                            directory = os.path.join(folder_path, data[num]["type"]) # Crée le chemin complet pour le nouveau dossier
                            os.makedirs(directory, exist_ok=True) # Crée le nouveau dossier à l'emplacement spécifié


#Pour finir on tri nos fichiers et on les envois la ou ils doivent etre   
                            try:
                                if elements[4] in ["0","1"]:  #Pour les fichiers n'ayant pas de profondeur, on n'affichera pas cette dernière dans les liste.

                                    try :
                                        with open(ressource_path(f"{directory}/{data[num]['type']}.txt"),"a") as f: #On ouvre chaque "phrases"
                                            f.write(f"{num} {data[num]['type']} {data[num]['nom']} {data[num]['longueur']}cm x {data[num]['largeur']}cm  {data[num]['prix']} €  \n") #On place les éléments dans l'ordre et on écrit

                                    except Exception as e:
                                        self.ERRORS("Il y a un probleme l'enregistrement de la liste contenant des oeuvres sans profondeur", e)
                                        return 
                                    
                                else :
                                    try :    
                                        with open(ressource_path(f"{directory}/{data[num]['type']}.txt"), "a") as f:
                                            f.write(f"{num} {data[num]['type']} {data[num]['nom']} {data[num]['longueur']}cm x {data[num]['largeur']}cm x {data[num]['profondeur']}cm {data[num]['prix']} € \n")

                                    except Exception as e:
                                        self.ERRORS("Il y a un probleme l'enregistrement de la liste contenant des oeuvres avec profondeur", e)
                                        return 
                                    

                            except Exception as e:
                                self.ERRORS("Il y a un probleme avec la liste choisie", e)
                                return 

                    except Exception as e:
                        self.ERRORS("Il y a eu un probleme avec la récupération des noms dans la liste : \n\n Il est probable que la liste ne soit pas au bon format \n\n consultez le tutoriel pour + d'infos", e)
                        return 

            except Exception as e:
                self.ERRORS("FELICITATION !!! \n\n Vous m'avez cassé. \n\n L'erreur rencontrée m'est totalement inconnue", e)
                return 


            #On terminera en affichant un pop up expliquant que le script a bien fonctionné.
            QMessageBox.information(self, "Information", "Je suis entrain de trier correctement tout ca.")


#____ ____ ____ _  _ ____ ___    _    ____ _  _ _  _ ____ _  _
#|__/ |  | |    |_/  |___  |     |    |__| |  | |\ | |    |__|
#|  \ |__| |___ | \_ |___  |     |___ |  | |__| | \| |___ |  |


#Pour finir on lance notre application 
if __name__ == "__main__":

    #Configuration du logeur d'erreurs : 
    logger = logging.getLogger(__name__) #créé une instance pour le module actuel
    logger.setLevel(logging.DEBUG) #Inclut tout les niveaux de debug (alert, info,...)
    handler = logging.FileHandler(ressource_path(r'error.log')) #Création du "gestionnaire" de messages d'erreurs
    handler.setLevel(logging.ERROR)
    formatter = logging.Formatter('%(asctime)s - %(levelname)s - %(message)s') #Tri les données selon leur affiliation
    handler.setFormatter(formatter) #Associe le formateur de données
    logger.addHandler(handler) #Ajout du format au logger

    app = QApplication(sys.argv)
    window = trieur()
    sys.exit(app.exec_())